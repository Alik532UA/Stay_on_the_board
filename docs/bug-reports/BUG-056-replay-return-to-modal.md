---
id: BUG-056
title: Після виходу з "Переглянути запис" запускається нова гра замість повернення до модального вікна
status: fixed
---

### Опис

Коли користувач знаходиться в модальному вікні "Суперник у пастці!" і натискає "Переглянути запис", а потім намагається повернутися назад, гра запускає нову гру замість повернення до попереднього модального вікна.

### Кроки для відтворення

1. Вікно "Суперник у пастці!"
2. Натиснути "Переглянути запис"
3. Вийти з "Переглянути запис"

### Актуальний результат

Нова гра

### Очікуваний результат

Вікно "Суперник у пастці!"

### Рішення

**Проблема:** Кнопка "Назад" на сторінці replay використовувала `history.back()`, що могло призвести до повернення на головне меню або запуску нової гри.

**Виправлення:**

1. **Збереження контексту модального вікна:** Модифіковано `startReplay()` в `gameOrchestrator.ts` для збереження контексту модального вікна в `sessionStorage` разом з даними replay.

2. **Універсальна логіка контексту:** Створено метод `_getCurrentModalContext()` для автоматичного визначення та збереження контексту будь-якого модального вікна, яке має кнопку "Переглянути запис".

3. **Оновлена логіка повернення:** Модифіковано `FloatingBackButton.svelte` для перевірки наявності контексту модального вікна та відновлення його при поверненні.

4. **Підтримка всіх типів модальних вікон:** Реалізовано підтримку всіх модальних вікон, які мають кнопку "Переглянути запис":
   - "Суперник у пастці!" (`modal.computerNoMovesContent`)
   - "Блискуча аналітика!" (`modal.playerNoMovesContent`)
   - "Помилкове твердження!" (`modal.errorContent`)
   - Загальне модальне вікно завершення гри

### Технічні деталі

- **Збереження контексту:** Контекст модального вікна зберігається в `sessionStorage` разом з даними replay
- **Відновлення модального вікна:** При поверненні з replay система автоматично відновлює модальне вікно з правильними кнопками та обробниками подій
- **Очищення даних:** Після відновлення модального вікна дані replay видаляються з `sessionStorage`

### Перевірка

- [x] Повернення з replay до модального вікна "Суперник у пастці!"
- [x] Повернення з replay до модального вікна "Блискуча аналітика!"
- [x] Повернення з replay до модального вікна "Помилкове твердження!"
- [x] Повернення з replay до загального модального вікна завершення гри
- [x] Звичайна навігація назад, якщо контексту модального вікна немає 