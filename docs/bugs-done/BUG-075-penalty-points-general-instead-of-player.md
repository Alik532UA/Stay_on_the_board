---
status: done
---

# BUG-075: –®—Ç—Ä–∞—Ñ–Ω—ñ –±–∞–ª–∏ –Ω–∞—Ä–∞—Ö–æ–≤—É—é—Ç—å—Å—è –∑–∞–≥–∞–ª—å–Ω–æ –∑–∞–º—ñ—Å—Ç—å –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–º—É –≥—Ä–∞–≤—Ü—é –≤ –ª–æ–∫–∞–ª—å–Ω–∏—Ö —ñ–≥—Ä–∞—Ö

## –û–ø–∏—Å –ø—Ä–æ–±–ª–µ–º–∏

**–®–ª—è—Ö:** `/game/local`

**–ê–∫—Ç—É–∞–ª—å–Ω–∏–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:** –®—Ç—Ä–∞—Ñ–Ω—ñ –±–∞–ª–∏ –Ω–µ –Ω–∞—Ä–∞—Ö–æ–≤—É—é—Ç—å—Å—è —Ç–æ–º—É –≥—Ä–∞–≤—Ü—é —è–∫–∏–π —ó—Ö –æ—Ç—Ä–∏–º–∞–≤

**–û—á—ñ–∫—É–≤–∞–Ω–∏–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:** –®—Ç—Ä–∞—Ñ–Ω—ñ –±–∞–ª–∏ –Ω–∞—Ä–∞—Ö–æ–≤—É—é—Ç—å—Å—è —Ç–æ–º—É –≥—Ä–∞–≤—Ü—é —è–∫–∏–π —ó—Ö –æ—Ç—Ä–∏–º–∞–≤, –≤—ñ–¥–æ–±—Ä–∞–∂–∞—î—Ç—å—Å—è –±—ñ–ª—è –æ—Å–Ω–æ–≤–Ω–∏—Ö –±–∞–ª—ñ–≤ –≤ score-row

## –ê–Ω–∞–ª—ñ–∑ –ø—Ä–æ–±–ª–µ–º–∏

### –ü—Ä–∏—á–∏–Ω–∞
–í –ª–æ–∫–∞–ª—å–Ω–∏—Ö —ñ–≥—Ä–∞—Ö —à—Ç—Ä–∞—Ñ–Ω—ñ –±–∞–ª–∏ –∑–∞ "–¥–∑–µ—Ä–∫–∞–ª—å–Ω—ñ" —Ö–æ–¥–∏ –Ω–∞—Ä–∞—Ö–æ–≤—É–≤–∞–ª–∏—Å—è –¥–æ –∑–∞–≥–∞–ª—å–Ω–æ–≥–æ `penaltyPoints` –≤ `gameState`, –∞ –Ω–µ –¥–æ —Ä–∞—Ö—É–Ω–∫—É –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –≥—Ä–∞–≤—Ü—è –≤ `localGameStore`.

### –î–æ–¥–∞—Ç–∫–æ–≤–∞ –ø—Ä–æ–±–ª–µ–º–∞
–õ–æ–≥—ñ–∫–∞ –≤ `calculateMoveScore` –¥–æ–¥–∞–≤–∞–ª–∞ —à—Ç—Ä–∞—Ñ–Ω—ñ –±–∞–ª–∏ –¥–æ –∑–∞–≥–∞–ª—å–Ω–æ–≥–æ —Ä–∞—Ö—É–Ω–∫—É –Ω–∞–≤—ñ—Ç—å –¥–ª—è –ª–æ–∫–∞–ª—å–Ω–∏—Ö —ñ–≥–æ—Ä, –¥–µ –∫–æ–∂–µ–Ω –≥—Ä–∞–≤–µ—Ü—å –º–∞—î —Å–≤—ñ–π –æ–∫—Ä–µ–º–∏–π —Ä–∞—Ö—É–Ω–æ–∫.

## –†—ñ—à–µ–Ω–Ω—è

### 1. –ú–æ–¥–∏—Ñ—ñ–∫–∞—Ü—ñ—è `calculateMoveScore`
–ó–º—ñ–Ω–µ–Ω–æ –ª–æ–≥—ñ–∫—É –¥–ª—è –ª–æ–∫–∞–ª—å–Ω–∏—Ö —ñ–≥–æ—Ä - —à—Ç—Ä–∞—Ñ–Ω—ñ –±–∞–ª–∏ –Ω–µ –¥–æ–¥–∞—é—Ç—å—Å—è –¥–æ –∑–∞–≥–∞–ª—å–Ω–æ–≥–æ `penaltyPoints`:

```typescript
function calculateMoveScore(
  currentState: any,
  newPosition: { row: number; col: number },
  playerIndex: number,
  settings: any
): { score: number; penaltyPoints: number; movesInBlockMode: number; jumpedBlockedCells: number } {
  // ...
  const humanPlayersCount = currentState.players.filter(p => p.type === 'human').length;
  console.log(`üîç calculateMoveScore: humanPlayersCount = ${humanPlayersCount}, playerIndex = ${playerIndex}`);
  
  if (currentState.moveHistory.length >= 2) {
    const computerOriginPosition = currentState.moveHistory[currentState.moveHistory.length - 2].pos;
    const computerRow = Array.isArray(computerOriginPosition) ? computerOriginPosition[0] : computerOriginPosition.row;
    const computerCol = Array.isArray(computerOriginPosition) ? computerOriginPosition[1] : computerOriginPosition.col;
    
    if (newPosition.row === computerRow && newPosition.col === computerCol) {
      if (humanPlayersCount <= 1) {
        console.log(`üéØ calculateMoveScore: –¥–æ–¥–∞—î–º–æ 2 —à—Ç—Ä–∞—Ñ–Ω–∏—Ö –±–∞–ª–∏ –¥–æ –∑–∞–≥–∞–ª—å–Ω–æ–≥–æ penaltyPoints (single player game)`);
        newPenaltyPoints += 2;
      } else {
        console.log(`üéØ calculateMoveScore: –ù–ï –¥–æ–¥–∞—î–º–æ —à—Ç—Ä–∞—Ñ–Ω—ñ –±–∞–ª–∏ –¥–æ –∑–∞–≥–∞–ª—å–Ω–æ–≥–æ penaltyPoints (local game), –±—É–¥—É—Ç—å –¥–æ–¥–∞–Ω—ñ –¥–æ –≥—Ä–∞–≤—Ü—è –≤ performMove`);
      }
    }
  }
  // ...
}
```

### 2. –ú–æ–¥–∏—Ñ—ñ–∫–∞—Ü—ñ—è `performMove`
–î–æ–¥–∞–Ω–æ –ª–æ–≥—ñ–∫—É –¥–ª—è –Ω–∞—Ä–∞—Ö—É–≤–∞–Ω–Ω—è —à—Ç—Ä–∞—Ñ–Ω–∏—Ö –±–∞–ª—ñ–≤ –±–µ–∑–ø–æ—Å–µ—Ä–µ–¥–Ω—å–æ –¥–æ —Ä–∞—Ö—É–Ω–∫—É –≥—Ä–∞–≤—Ü—è:

```typescript
export async function performMove(direction: MoveDirectionType, distance: number, playerIndex: number = 0) {
  // ...
  const currentStateAfterMove = get(gameState);
  const humanPlayersCount = currentStateAfterMove.players.filter(p => p.type === 'human').length;
  
  if (humanPlayersCount > 1) {
    const currentPlayer = currentStateAfterMove.players[playerIndex];
    if (currentPlayer) {
      const localGameState = get(localGameStore);
      const localPlayer = localGameState.players.find(p => p.name === currentPlayer.name);
      
      if (localPlayer) {
        console.log(`üéØ performMove: –¥–æ–¥–∞—î–º–æ 1 –±–∞–ª –≥—Ä–∞–≤—Ü—é ${currentPlayer.name} –∑–∞ —Ö—ñ–¥`);
        localGameStore.addPlayerScore(localPlayer.id, 1);
        
        // –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ —á–∏ –±—É–≤ "–¥–∑–µ—Ä–∫–∞–ª—å–Ω–∏–π" —Ö—ñ–¥ –¥–ª—è –Ω–∞—Ä–∞—Ö—É–≤–∞–Ω–Ω—è —à—Ç—Ä–∞—Ñ–Ω–∏—Ö –±–∞–ª—ñ–≤
        if (currentState.moveHistory.length >= 2) {
          const computerOriginPosition = currentState.moveHistory[currentState.moveHistory.length - 2].pos;
          const computerRow = Array.isArray(computerOriginPosition) ? computerOriginPosition[0] : computerOriginPosition.row;
          const computerCol = Array.isArray(computerOriginPosition) ? computerOriginPosition[1] : computerOriginPosition.col;
          
          if (newPosition.row === computerRow && newPosition.col === computerCol) {
            console.log(`üéØ performMove: –¥–æ–¥–∞—î–º–æ 2 —à—Ç—Ä–∞—Ñ–Ω–∏—Ö –±–∞–ª–∏ –≥—Ä–∞–≤—Ü—é ${currentPlayer.name} –∑–∞ "–¥–∑–µ—Ä–∫–∞–ª—å–Ω–∏–π" —Ö—ñ–¥`);
            localGameStore.addPlayerScore(localPlayer.id, 2);
            console.log(`‚úÖ performMove: —à—Ç—Ä–∞—Ñ–Ω—ñ –±–∞–ª–∏ –¥–æ–¥–∞–Ω–æ –≥—Ä–∞–≤—Ü—é ${currentPlayer.name}`);
          }
        }
      }
    }
  }
  // ...
}
```

### 3. –î–æ–¥–∞–≤–∞–Ω–Ω—è –ª–æ–≥—É–≤–∞–Ω–Ω—è –≤ `localGameStore`
–î–æ–¥–∞–Ω–æ –¥–µ—Ç–∞–ª—å–Ω–µ –ª–æ–≥—É–≤–∞–Ω–Ω—è –¥–ª—è –≤—ñ–¥—Å—Ç–µ–∂–µ–Ω–Ω—è –æ–Ω–æ–≤–ª–µ–Ω—å —Ä–∞—Ö—É–Ω–∫—ñ–≤:

```javascript
addPlayerScore: (playerId, pointsToAdd) => {
  console.log(`üéØ localGameStore.addPlayerScore: –¥–æ–¥–∞—î–º–æ ${pointsToAdd} –±–∞–ª—ñ–≤ –≥—Ä–∞–≤—Ü—é –∑ ID ${playerId}`);
  update(state => {
    const updatedState = {
      ...state,
      players: state.players.map(p => 
        p.id === playerId ? { ...p, score: p.score + pointsToAdd } : p
      )
    };
    const updatedPlayer = updatedState.players.find(p => p.id === playerId);
    console.log(`‚úÖ localGameStore.addPlayerScore: —Ä–∞—Ö—É–Ω–æ–∫ –≥—Ä–∞–≤—Ü—è ${updatedPlayer?.name} –æ–Ω–æ–≤–ª–µ–Ω–æ –¥–æ ${updatedPlayer?.score}`);
    return updatedState;
  });
},
```

## –¢–µ—Å—Ç—É–≤–∞–Ω–Ω—è

### –°—Ü–µ–Ω–∞—Ä—ñ–π —Ç–µ—Å—Ç—É–≤–∞–Ω–Ω—è
1. –ó–∞–ø—É—Å—Ç–∏—Ç–∏ –ª–æ–∫–∞–ª—å–Ω—É –≥—Ä—É –≤ `/game/local`
2. –ó—Ä–æ–±–∏—Ç–∏ –∫—ñ–ª—å–∫–∞ —Ö–æ–¥—ñ–≤, –≤–∫–ª—é—á–∞—é—á–∏ "–¥–∑–µ—Ä–∫–∞–ª—å–Ω—ñ" —Ö–æ–¥–∏
3. –ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ —Ä–∞—Ö—É–Ω–∫–∏ –≥—Ä–∞–≤—Ü—ñ–≤ –≤ `score-panel`
4. –ü–µ—Ä–µ–∫–æ–Ω–∞—Ç–∏—Å—è, —â–æ —à—Ç—Ä–∞—Ñ–Ω—ñ –±–∞–ª–∏ –Ω–∞—Ä–∞—Ö–æ–≤—É—é—Ç—å—Å—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ–º—É –≥—Ä–∞–≤—Ü—é

### –û—á—ñ–∫—É–≤–∞–Ω–∏–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç
- –®—Ç—Ä–∞—Ñ–Ω—ñ –±–∞–ª–∏ –Ω–∞—Ä–∞—Ö–æ–≤—É—é—Ç—å—Å—è —Ç–æ–º—É –≥—Ä–∞–≤—Ü—é, —è–∫–∏–π –∑—Ä–æ–±–∏–≤ "–¥–∑–µ—Ä–∫–∞–ª—å–Ω–∏–π" —Ö—ñ–¥
- –†–∞—Ö—É–Ω–æ–∫ –≤—ñ–¥–æ–±—Ä–∞–∂–∞—î—Ç—å—Å—è –±—ñ–ª—è –æ—Å–Ω–æ–≤–Ω–∏—Ö –±–∞–ª—ñ–≤ —É `score-row`
- –õ–æ–≥—ñ–∫–∞ –ø—Ä–∞—Ü—é—î –æ–¥–Ω–∞–∫–æ–≤–æ –¥–ª—è –≤—Å—ñ—Ö –≥—Ä–∞–≤—Ü—ñ–≤

## –§–∞–π–ª–∏, —â–æ –±—É–ª–∏ –∑–º—ñ–Ω–µ–Ω—ñ

- `src/lib/services/gameLogicService.ts` - –º–æ–¥–∏—Ñ—ñ–∫–æ–≤–∞–Ω–æ –ª–æ–≥—ñ–∫—É –Ω–∞—Ä–∞—Ö—É–≤–∞–Ω–Ω—è —à—Ç—Ä–∞—Ñ–Ω–∏—Ö –±–∞–ª—ñ–≤
- `src/lib/stores/localGameStore.js` - –¥–æ–¥–∞–Ω–æ –ª–æ–≥—É–≤–∞–Ω–Ω—è –¥–ª—è `addPlayerScore`

## –°—Ç–∞—Ç—É—Å

‚úÖ **–í–ò–ü–†–ê–í–õ–ï–ù–û**

## –ü—Ä–∏–º—ñ—Ç–∫–∏

- –®—Ç—Ä–∞—Ñ–Ω—ñ –±–∞–ª–∏ —Ç–µ–ø–µ—Ä –Ω–∞—Ä–∞—Ö–æ–≤—É—é—Ç—å—Å—è –±–µ–∑–ø–æ—Å–µ—Ä–µ–¥–Ω—å–æ –¥–æ —Ä–∞—Ö—É–Ω–∫—É –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –≥—Ä–∞–≤—Ü—è
- –õ–æ–≥—ñ–∫–∞ —Ä–æ–∑–¥—ñ–ª–µ–Ω–∞ –º—ñ–∂ single-player —Ç–∞ local games
- –î–æ–¥–∞–Ω–æ –¥–µ—Ç–∞–ª—å–Ω–µ –ª–æ–≥—É–≤–∞–Ω–Ω—è –¥–ª—è –≤—ñ–¥—Å—Ç–µ–∂–µ–Ω–Ω—è –Ω–∞—Ä–∞—Ö—É–≤–∞–Ω—å
- –í–∏–ø—Ä–∞–≤–ª–µ–Ω–æ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è `moveHistory` –¥–ª—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ—ó –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏ "–¥–∑–µ—Ä–∫–∞–ª—å–Ω–∏—Ö" —Ö–æ–¥—ñ–≤ 