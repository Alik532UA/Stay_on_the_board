# BONUS_SCORING.md

## Система балів "Stay on the Board"

Документація повної системи нарахування балів, бонусів та штрафів у грі.

## Базові бали

### Нарахування за ходи
- **+1 бал**: за хід з видимою дошкою та ферзем
- **+2 бали**: за хід з видимою дошкою, але прихованим ферзем  
- **+3 бали**: за хід з прихованою дошкою (найскладніший режим)

### Умови нарахування
- Бали нараховуються тільки за ходи гравця (не комп'ютера)
- Кожен успішний хід дає бали відповідно до поточного режиму відображення
- Бали накопичуються протягом гри

## Бонусні бали

### 1. Бонус за відстань
- **+1 бал**: при ході на відстань більше 1
- **Формула**: завжди +1 бал, незалежно від відстані (якщо відстань > 1)
- **Умова**: хід повинен бути на відстань більше 1 клітинки
- **Приклад**: хід на відстань 2, 3, 4 або більше клітинок завжди дає +1 бонусний бал

### 2. Бонус за розмір дошки
- **Розрахунок**: відсоток від базового рахунку
- **Формула**: `(розмір_дошки × розмір_дошки) / 100 × базовий_рахунок`
- **Приклад**: на дошці 5×5 бонус = 25% від базового рахунку

### 3. Бонус за режим заблокованих клітинок
- **+1 бал**: за кожен хід, зроблений в режимі заблокованих клітинок
- **Нараховується**: автоматично при кожному ході в цьому режимі

### 4. Бонус за перестрибування
- **+1 бал**: за кожну перестрибнуту заблоковану клітинку
- **Умова**: клітинка повинна бути заблокована (відвідана більше разів, ніж ліміт)
- **Важливо**: бонуси нараховуються **тільки коли увімкнений "Режим заблокованих клітинок"** (`blockModeEnabled = true`)

### 5. Бонус "Ходів немає"
- **Розмір бонусу**: розмір дошки (наприклад, +5 балів на дошці 5×5)
- **Умова**: гравець правильно натискає "Ходів немає" (гра ще не завершена)
- **Нарахування**: нараховується кожен раз, коли гравець правильно натискає "Ходів немає"

### 6. Бонус за завершення гри
- **Розмір бонусу**: розмір дошки
- **Умова**: гравець натискає "Завершити" після перемоги
- **Приклад**: +5 балів на дошці 5×5

## Штрафні бали

### Штраф за "дзеркальні" ходи
- **-2 бали**: за кожен такий хід
- **Умова**: гравець робить хід у протилежному напрямку після ходу комп'ютера
- **Деталі**: 
  - Комп'ютер зробив хід на N клітинок у певному напрямку
  - Гравець одразу після цього робить хід у протилежному напрямку на N або меншу кількість клітинок
- **Обмеження**: штрафні бали не нараховуються в режимі заблокованих клітинок
- **Приклади**:
  - Комп'ютер: 3 праворуч → Гравець: 3, 2 або 1 ліворуч (штраф)
  - Комп'ютер: 2 вгору → Гравець: 2 або 1 вниз (штраф)
  - Комп'ютер: 4 вниз → Гравець: 4, 3, 2 або 1 вгору (штраф)

## Фінальний розрахунок

### Розрахунок за режимами гри

#### Режим `/game/vs-computer`
Повна формула з усіма бонусами:
```
Підсумковий рахунок = 
+  Базовий рахунок
+  Бонус за розмір дошки
+  Бонус за режим блокування
+  Бонус за відстань
+  Бонус за перестрибування
+  Бонус "Ходів немає"
+  Бонус за завершення гри
-  Штрафні бали
```

**Особливості режиму:**
- Бонусні бали нараховуються під час закінчення (або під час паузи) гри
- Включає всі типи бонусів та штрафів
- Штрафні бали застосовуються тільки в цьому режимі

#### Режими `/game/local` та `/game/online`
Спрощена формула з обмеженими бонусами:
```
Підсумковий рахунок = 
+  Бонус за відстань
+  Бонус за перестрибування
-  Штрафні бали
```

**Особливості режимів:**
- Бонусні бали нараховуються під час гри
- Включає тільки бонуси за відстань та перестрибування
- Штрафні бали застосовуються (якщо є)
- Не включає базовий рахунок, бонуси за розмір дошки, режим блокування, "Ходів немає" та завершення гри
- **Визначення переможця**: переможцем стає гравець з найбільшою кількістю балів серед тих, хто не вийшов за межі дошки або не потрапив на заблоковану клітинку

### Визначення переможця в локальній та онлайн грі

В режимах `/game/local` та `/game/online` переможець визначається за принципом "останній, хто залишився на дошці". Гравець з найбільшою кількістю балів серед тих, хто не вийшов за межі дошки або не потрапив на заблоковану клітинку, стає переможцем.

#### Приклади:

**Приклад 1: 2 гравці**
- Гравець 1 = 6 балів (вийшов за межі дошки)
- Гравець 2 = 5 балів (залишився на дошці)
- **Переможець**: Гравець 2 (незважаючи на меншу кількість балів, бо головна умова - не посунути фігуру куди не можна)

**Приклад 2: 4 гравці**
- Гравець 1 = 6 балів (вийшов за межі дошки)
- Гравець 2 = 2 бали (залишився на дошці)
- Гравець 3 = 4 бали (залишився на дошці)
- Гравець 4 = 5 балів (залишився на дошці)
- **Переможець**: Гравець 4 (найбільше балів серед тих, хто залишився на дошці)

**Приклад 3: 4 гравці з однаковою кількістю балів**
- Гравець 1 = 7 балів (вийшов за межі дошки)
- Гравець 2 = 5 балів (залишився на дошці)
- Гравець 3 = 5 балів (залишився на дошці)
- Гравець 4 = 3 бали (залишився на дошці)
- **Переможці**: Гравець 2 та Гравець 3 (найбільше балів серед тих, хто залишився на дошці - по 5 балів кожен)

### Приклади розрахунку

#### Приклад для режиму `/game/vs-computer`
**Умови**: дошка 5×5, режим заблокованих клітинок увімкнений, 10 ходів (середня відстань 2.5), 2 перестрибування, 1 штраф

- Базовий рахунок: 10 балів (10 ходів × 1 бал)
- Бонус за розмір дошки: 2.5 балів (25% від 10)
- Бонус за режим блокування: 10 балів (10 ходів × 1 бал)
- Бонус за відстань: 10 балів (10 ходів × 1 бал за ходи на відстань > 1)
- Бонус за перестрибування: 2 бали (2 перестрибування × 1 бал, тільки якщо blockModeEnabled = true)
- Бонус "Ходів немає": 5 балів (розмір дошки)
- Бонус за завершення гри: 5 балів (розмір дошки)
- Штрафні бали: -2 бали

**Підсумок**: 10 + 2.5 + 10 + 10 + 2 + 5 + 5 - 2 = **42.5 балів**

#### Приклад для режимів `/game/local` та `/game/online`
**Умови**: 10 ходів на відстань > 1, 2 перестрибування заблокованих клітинок, режим заблокованих клітинок увімкнений

- Бонус за відстань: 10 балів (10 ходів × 1 бал за ходи на відстань > 1)
- Бонус за перестрибування: 2 бали (2 перестрибування × 1 бал, тільки якщо blockModeEnabled = true)
- Штрафні бали: 0 балів (немає)

**Підсумок**: 10 + 2 - 0 = **12 балів**

### Приклад комбінованого бонусу
**Хід на відстань 3 з перестрибуванням 2 заблокованих клітинок (blockModeEnabled = true):**
- Бонус за відстань: 1 бал (хід на відстань > 1)
- Бонус за перестрибування: 2 бали (2 перестрибнуті клітинки)
- **Загальний бонус за хід: 3 бали**

**Хід на відстань 3 з перестрибуванням 2 заблокованих клітинок (blockModeEnabled = false):**
- Бонус за відстань: 1 бал (хід на відстань > 1)
- Бонус за перестрибування: 0 балів (blockModeEnabled = false)
- **Загальний бонус за хід: 1 бал**

## Відображення в інтерфейсі

### Панель рахунку
- Показує поточний рахунок в реальному часі
- Відображає штрафні бали (якщо є)
- Клік по рахунку відкриває детальну інформацію

### Модальні вікна
- **Детальний розбір рахунку**: показує всі компоненти фінального рахунку
- **Інформація про бали**: пояснення системи нарахування
- **Інформація про штрафи**: пояснення штрафних балів

### Кнопки дій
- **"Завершити (+X балів)"**: показує потенційний бонус за завершення
- **"Ходів немає"**: дозволяє заявити про відсутність ходів

## Технічна реалізація

### Основні функції
- `calculateFinalScore()` - розрахунок фінального рахунку
- `calculateMoveScore()` - розрахунок балів за окремий хід
- `countJumpedCells()` - підрахунок перестрибнутих клітинок

### Структура даних
```typescript
interface FinalScore {
  baseScore: number;           // Базовий рахунок
  totalPenalty: number;        // Загальні штрафні бали
  sizeBonus: number;          // Бонус за розмір дошки
  blockModeBonus: number;     // Бонус за режим блокування
  distanceBonus: number;      // Бонус за відстань
  jumpBonus: number;          // Бонус за перестрибування
  noMovesBonus: number;       // Бонус "Ходів немає"
  finishBonus: number;        // Бонус за завершення гри
  totalScore: number;         // Підсумковий рахунок
}
```

## Примітки

- Всі бонуси та штрафи нараховуються автоматично
- Система підтримує дробові значення для бонусів за розмір дошки
- Штрафні бали застосовуються тільки в грі з комп'ютером
- Бонус "Ходів немає" нараховується кожен раз при правильному натисканні
- В режимі заблокованих клітинок штрафні бали не нараховуються
- **Режим `/game/vs-computer`**: бонусні бали нараховуються під час закінчення (або паузи) гри
- **Режими `/game/local` та `/game/online`**: бонусні бали нараховуються під час гри 