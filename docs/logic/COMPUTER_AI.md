# Алгоритм комп'ютера

Цей документ описує логіку роботи штучного інтелекту комп'ютера в грі "Stay on the Board".

## Основна концепція

Комп'ютер використовує **випадковий алгоритм** для вибору ходів. Це означає, що:
- Комп'ютер не має стратегії
- Всі валідні ходи мають однакову ймовірність
- Ходи комп'ютера передбачувані в короткостроковій перспективі
- Комп'ютер грає чесно, без переваг

> **Примітка:** Раніше комп'ютер використовував алгоритм вибору найкращого ходу (з найбільшою кількістю очок), що призводило до передбачуваної поведінки. Це було виправлено в версії 2.0 - тепер комп'ютер використовує повністю випадковий вибір.

> **Виправлення багу (2025):** Виправлено проблему з детермінованим вибором ходів комп'ютера. Додано подвійне перемішування: спочатку напрямків при генерації ходів, потім самих ходів при виборі. Це забезпечує повну випадковість та усуває передбачувану поведінку.

## Алгоритм вибору ходу

### Крок 1: Отримання валідних ходів
```javascript
function getAllValidMoves() {
    // Отримує всі можливі ходи з поточної позиції фігури
    // Перевіряє валідність кожного ходу для комп'ютера (player 1 в грі з комп'ютером)
    // Перемішує напрямки для кращої випадковості
    const directions = [1, 2, 3, 4, 6, 7, 8, 9].sort(() => Math.random() - 0.5);
    // Повертає масив валідних ходів
}
```

### Крок 2: Випадковий вибір
```javascript
function selectBestMove(moves) {
    console.log('[GameLogic] selectBestMove called with moves:', moves);
    
    if (moves.length === 0) {
        console.log('[GameLogic] No moves available');
        return null;
    }
    
    // Покращений випадковий алгоритм з додатковим перемішуванням
    // Спочатку перемішуємо масив ходів для кращої випадковості
    const shuffledMoves = [...moves].sort(() => Math.random() - 0.5);
    console.log('[GameLogic] Shuffled moves:', shuffledMoves);
    
    // Вибираємо випадковий хід з перемішаного масиву
    const randomIndex = Math.floor(Math.random() * shuffledMoves.length);
    const selectedMove = shuffledMoves[randomIndex];
    
    console.log('[GameLogic] Random index:', randomIndex, 'Selected move:', selectedMove);
    return selectedMove;
}
```

### Крок 3: Виконання ходу
```javascript
function executeComputerMove(move) {
    // Оновлює позицію фігури
    // Оновлює рахунок
    // Перевіряє кінець гри
    // Передає чергу гравцю
}
```

## Структура ходу

### Об'єкт ходу
```javascript
{
    direction: 1-8,        // Напрямок руху
    distance: 1-N,         // Відстань руху
    newPosition: [x, y],   // Нова позиція
    isValid: boolean       // Чи валідний хід
}
```

### Напрямки
```
7 8 9
4 ♛ 6
1 2 3
```

## Перевірка валідності ходу

### Умови валідності
1. **В межах дошки**: нова позиція знаходиться в межах дошки
2. **Не заблокована**: нова позиція не є заблокованою клітинкою (в режимі заблокованих клітинок)

### Функція перевірки
```javascript
function isValidMove(direction, distance) {
    const newPosition = calculateNewPosition(currentPosition, direction, distance);
    
    // Перевірка меж дошки
    if (newPosition.x < 0 || newPosition.x >= boardSize ||
        newPosition.y < 0 || newPosition.y >= boardSize) {
        return false;
    }
    
    // Перевірка заблокованих клітинок
    if (blockedCellsMode && isBlocked(newPosition)) {
        return false;
    }
    
    return true;
}
```

## Таймінг та затримки

### Затримка між ходами
- **1 секунда** між ходом гравця та ходом комп'ютера
- Затримка додає реалістичності та дає час гравцю побачити свій хід

### Реалізація затримки
```javascript
function computerTurn() {
    // Показує повідомлення "Хід комп'ютера..."
    showMessage("Хід комп'ютера...");
    
    // Затримка 1 секунда
    setTimeout(() => {
        const move = computerMove();
        executeComputerMove(move);
    }, 1000);
}
```

## Особливості алгоритму

### Випадковість
- Використовується `Math.random()` для вибору ходу
- Подвійне перемішування: напрямків при генерації та ходів при виборі
- Кожен хід незалежний від попередніх
- Немає "пам'яті" про попередні ходи
- Додаткове логування для відстеження випадковості

### Передбачуваність
- В короткостроковій перспективі ходи можна передбачити
- В довгостроковій перспективі ходи випадкові
- Гравець може використовувати це для стратегії

### Честність
- Комп'ютер не має переваг
- Не використовує "заздалегідь знання" про ходи гравця
- Грає з тими ж правилами, що й гравець

## Стратегічні наслідки

### Для гравця
1. **Використання передбачуваності**: гравець може планувати на кілька ходів вперед
2. **Створення пасток**: гравець може заманювати комп'ютер в невигідні позиції
3. **Контроль центру**: центральні клітинки дають перевагу проти випадкового суперника

### Для гри
1. **Баланс**: випадковий алгоритм забезпечує баланс між складністю та доступністю
2. **Навчання**: гравець може навчитися стратегії без складного суперника
3. **Розвага**: гра залишається цікавою навіть при повторних іграх

## Можливі покращення

### Рівні складності
- **Легкий**: поточний випадковий алгоритм
- **Середній**: алгоритм з базовою стратегією
- **Важкий**: алгоритм з глибоким аналізом позиції

### Стратегічні елементи
- **Уникнення кутів**: комп'ютер уникає кутових позицій
- **Контроль центру**: комп'ютер намагається залишатися в центрі
- **Блокування шляхів**: в режимі заблокованих клітинок

### Адаптивність
- **Аналіз стилю гравця**: комп'ютер адаптується до стилю гри
- **Рівень складності**: автоматичне налаштування складності
- **Навчання**: комп'ютер навчається з ігор

## Технічна реалізація

### Файли
- `js/game-logic-new.js` - основна логіка гри
- `js/game-core.js` - алгоритм комп'ютера
- `js/components/game-board-component.js` - інтерфейс гри

### Функції
```javascript
// Основні функції алгоритму
makeComputerMove()       // Основний метод ходу комп'ютера
selectBestMove()         // Вибирає випадковий хід з доступних
getAllValidMoves()       // Отримує валідні ходи
executeMove()           // Виконує хід (використовується для обох гравців)
```

### Події
- `computerTurn` - початок ходу комп'ютера
- `computerMove` - виконання ходу комп'ютера
- `gameEnd` - кінець гри

## Тестування алгоритму

### Метрики
- **Відсоток перемог**: скільки разів комп'ютер перемагає
- **Середня кількість ходів**: скільки ходів триває гра
- **Розподіл ходів**: які напрямки та відстані вибирає комп'ютер

### Валідація
- Перевірка валідності всіх ходів
- Перевірка відсутності переваг
- Перевірка випадковості розподілу

## Пов'язані файли

- [GAME_RULES.md](GAME_RULES.md) - Правила гри та механіка
- [GAME_STATES.md](GAME_STATES.md) - Стани гри та переходи
- [UI_COMPONENTS.md](UI_COMPONENTS.md) - Логіка всіх UI елементів
- [KEYBOARD_SHORTCUTS.md](KEYBOARD_SHORTCUTS.md) - Клавіатурні скорочення 