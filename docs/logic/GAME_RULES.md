# Тип: Документація
# Статус: Актуально
# Назва: Правила гри Stay on the Board
# Мета: Дати повний і зрозумілий опис усіх правил гри для гравців і розробників.
# Опис: Офіційний опис правил, механік, режимів та підрахунку очок для гри Stay on the Board. Містить усі базові та додаткові правила, приклади та підказки.

# Правила гри "Stay on the Board"

## Основна концепція

**"Stay on the Board"** - це стратегічна гра, де мета полягає в тому, щоб якомога довше втримати фігуру на дошці, уникаючи виходу за її межі або потрапляння на недоступні клітинки.

## Основні правила

### Початкові умови
1. **Початкова позиція**: Фігура (♛) розміщується випадково на дошці
2. **Чергування**: Гравці ходять по черзі, рухаючи ту ж саму фігуру
3. **Хід**: Гравець вибирає напрямок (8 можливостей) та відстань (1 до N-1 клітинок)
4. **Перемога**: Гравець, який залишиться на дошці довше, перемагає

### Умови поразки
Гравець програє, якщо:
- **Вихід за межі дошки**: хід виводить фігуру за межі дошки
- **Заблокована клітинка**: хід веде на заблоковану клітинку (в режимі заблокованих клітинок)
- **Неправильна заява**: гравець натискає "Немає ходів", але ходи є

### Умови перемоги
Гравець перемагає, якщо:
- **Правильна заява**: гравець натискає "Немає ходів" і дійсно ходів немає
- **Помилка суперника**: суперник робить недопустимий хід

## Механіка ходів

**Фігура ходить як ферзь у шахах:** тобто може рухатися по горизонталі, вертикалі або діагоналі на будь-яку кількість клітинок. На відміну від шахового ферзя, у цій грі фігура має "суперздібність" — вона може перестрибувати заблоковані клітинки, але не може зупинятися на них чи виходити за межі дошки.

### Напрямки руху
Гравець може рухати фігуру в 8 напрямках:
```
7 8 9
4 ♛ 6
1 2 3
```

- **7**: вгору-ліворуч (↖)
- **8**: вгору (↑)
- **9**: вгору-праворуч (↗)
- **4**: ліворуч (←)
- **6**: праворуч (→)
- **1**: вниз-ліворуч (↙)
- **2**: вниз (↓)
- **3**: вниз-праворуч (↘)

### Відстань руху
- **Мінімальна**: 1 клітинка
- **Максимальна**: N-1 клітинок (де N - розмір дошки)
- **Приклад**: на дошці 5x5 можна рухатися на 1-4 клітинки

### Валідність ходу
Хід вважається валідним, якщо:
1. Нова позиція знаходиться в межах дошки
2. Нова позиція не є заблокованою клітинкою (в режимі заблокованих клітинок)

## Режими гри

### Звичайний режим
- Всі клітинки залишаються доступними після ходів
- Гра закінчується тільки при виході за межі дошки
- Простіший для початківців

### Режим заблокованих клітинок
- Клітинка, з якої зроблено хід, стає недоступною
- Заблоковані клітинки позначаються чорним кольором з червоним ✗
- Гра закінчується при:
  - Виході за межі дошки
  - Потраплянні на заблоковану клітинку
- Складніший стратегічний режим

## Система очок

### Підрахунок очок
- **1 очко** за кожен успішний хід
- **Фінальний рахунок** = кількість зроблених ходів
- **Вищий рахунок** = кращий результат

### Відображення
- Очки показуються в реальному часі
- Фінальний рахунок відображається в кінці гри
- Рахунок зберігається протягом однієї гри

## Кнопка "Немає ходів"

### Логіка роботи
1. **Перевірка**: система перевіряє всі можливі ходи
2. **Результат**:
   - **Якщо ходів немає**: гравець перемагає
   - **Якщо ходи є**: гравець програє

### Стратегічне використання
- Використовується, коли гравець вважає, що не може зробити жодного валідного ходу
- Ризикована стратегія - помилка призводить до поразки
- Може бути використана для швидкого завершення гри

## Розміри дошки

### Доступні розміри
- **Мінімальний**: 2x2
- **Максимальний**: 9x9
- **За замовчуванням**: 3x3

### Вплив розміру на гру
- **Менші дошки**: швидша гра, менше стратегії
- **Більші дошки**: повільніша гра, більше стратегії
- **Оптимальний**: 5x5 для балансу швидкості та стратегії

## Типи ігор

### Гра з комп'ютером
- **Гравець vs Комп'ютер**
- Після натискання "Гра з комп'ютером" спочатку з'являється модальне вікно "Вибір режиму гри" (GameModeModal).
- Гравець обирає режим: звичайний або з заблокованими клітинками.
- Лише після вибору режиму починається гра.
- Вибраний режим має бути застосований у налаштуваннях гри (settingsStore) та підсвічуватися у блоці game-mode-row у меню налаштувань.
- Якщо модальне вікно закрито — повернення до головного меню.
- Комп'ютер ходить після кожного ходу гравця
- Затримка 1 секунда між ходами комп'ютера
- Детальніше дивіться [COMPUTER_AI.md](COMPUTER_AI.md)

### Локальна гра
- **Гравець 1 vs Гравець 2**
- Гравці ходять по черзі на одному пристрої
- Можна ввести імена гравців

### Онлайн гра
- **Гравець vs Гравець через інтернет**
- Використовує PeerJS для P2P з'єднання
- Хост створює кімнату, гість приєднується
- Детальніше дивіться [NAVIGATION.md](NAVIGATION.md)

## Візуальні підказки

### Показ доступних ходів
- **Чекбокс "Показувати доступні ходи"**
- Показує галочки на всіх можливих клітинках
- Автоматично оновлюється після кожного ходу
- Допомагає планувати стратегію

### Центральна кнопка
- Показує вибраний напрямок та відстань
- Стає кнопкою підтвердження при повному виборі
- Показує хід комп'ютера після його виконання

## Стратегічні поради

### Загальні принципи
1. **Плануйте наперед**: думайте про наступні ходи
2. **Уникайте кутів**: кутові клітинки обмежують можливості
3. **Використовуйте центр**: центральні клітинки дають більше варіантів

### В режимі заблокованих клітинок
1. **Блокуйте стратегічно**: залишайте собі шляхи відступу
2. **Контролюйте простір**: не блокуйте всі шляхи одразу
3. **Плануйте довгостроково**: думайте про кінець гри

### Проти комп'ютера
1. **Використовуйте передбачуваність**: комп'ютер ходить випадково
2. **Створюйте пастки**: заманюйте комп'ютер в невигідні позиції
3. **Контролюйте центр**: центральні клітинки дають перевагу

## Технічна реалізація

### Структура даних
- **board**: двовимірний масив, що представляє дошку (фігура завжди має значення 1)
- **blockedCells**: масив заблокованих позицій
- **points**: лічильник очок
- **currentPlayer**: поточний гравець (1 або 2)

### Функції перевірки
- **getAllValidMoves()**: отримує всі можливі ходи для поточного гравця
- **hasValidMoves()**: перевіряє чи є ходи для поточного гравця
- **findPiece()**: знаходить позицію фігури на дошці

### Обробка ходів
- **processPlayerMove()**: обробляє хід гравця та передає чергу комп'ютеру
    - Після зміни currentPlayer на 2 (комп'ютер) одразу оновлюються доступні ходи для комп'ютера, щоб його хід був коректним
- **makeComputerMove()**: виконує хід комп'ютера та передає чергу гравцю
- **executeMove()**: виконує хід (спільна функція для гравця та комп'ютера)
- **endGame()**: завершує гру

## Штрафні бали

- **Штрафні бали** нараховуються, якщо гравець робить гарантовано безпечний хід після ходу комп'ютера:
  - Якщо комп'ютер зробив хід на N клітинок у певному напрямку, а гравець одразу після цього робить хід у протилежному напрямку на N або меншу кількість клітинок, гравець отримує штраф.
  - Це зроблено, щоб уникнути нескінченних "обмінів" та хітрощів.
  - **Штраф = +2 бали** за кожен такий хід.
  - **У режимі заблокованих клітинок штрафні бали не нараховуються** (бо повернення на ту ж клітинку неможливе).

### Приклад:
- Комп'ютер: 3 праворуч → Гравець: 3, 2 або 1 ліворуч (штраф)
- Комп'ютер: 2 вгору → Гравець: 2 або 1 вниз (штраф)
- Комп'ютер: 4 вниз → Гравець: 4, 3, 2 або 1 вгору (штраф)

## Пов'язані файли

- [UI_COMPONENTS.md](UI_COMPONENTS.md) - Логіка всіх UI елементів
- [GAME_STATES.md](GAME_STATES.md) - Стани гри та переходи
- [KEYBOARD_SHORTCUTS.md](KEYBOARD_SHORTCUTS.md) - Клавіатурні скорочення
- [COMPUTER_AI.md](COMPUTER_AI.md) - Алгоритм комп'ютера 

---

## ВАЖЛИВО ДЛЯ РОЗРОБНИКІВ: ініціалізація чекбоксів перед стартом гри

Щоб уникнути візуального блимання дошки та забезпечити коректний UX:
- Чекбокси 'Показати ферзя' (showQueen) та 'Показувати доступні ходи' (showMoves) мають вмикатися ДО старту нової гри (до появи дошки).
- Не вмикайте showBoard автоматично, якщо autoHideBoard=true — дошка має залишатися прихованою.
- Не перемикайте ці чекбокси після першого ходу — це призводить до блимання.
- Якщо змінюєте цю логіку під час рефакторингу, ОБОВʼЯЗКОВО перевірте, що не виникає блимання і всі чекбокси працюють як треба.

Деталі див. у функції resetGame (gameActions.ts). 

---

## ВАЖЛИВО ДЛЯ РОЗРОБНИКІВ: асинхронність та незалежність візуалізації дошки

### Принципи архітектури (не можна порушувати при рефакторингу!)

1. Візуалізація дошки (компонент 'game-board') є асинхронною щодо логіки гри та анімацій керування.
2. 'game-board' не впливає на 'center-info' та не впливає на логіку гри (стан, черговість, підрахунок ходів тощо).
3. 'center-info' та логіка гри не знають і не залежать від стану візуалізації дошки ('game-board').
4. Логіка гри не повинна знати про DOM, анімації чи рендеринг — лише про ігровий стан.

**Це критично для коректної роботи анімацій, UX та підтримки масштабованості.**

Якщо змінюєте цю архітектуру — ОБОВʼЯЗКОВО погоджуйте з автором або проведіть повне тестування всіх сценаріїв!

Деталі див. у компонентах 'game-board', 'center-info' та у файлах логіки гри. 