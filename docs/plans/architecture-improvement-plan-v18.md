# План покращення архітектури v18

## Частина 1: Комплексний аудит коду

### Архітектура та Структура

1.  **SSoT (Single Source of Truth):**
    *   **Оцінка: 95/100**
    *   **Обґрунтування:** Стан гри централізовано в `gameState`, що є чудовим прикладом SSoT. Майже всі компоненти залежать від цього єдиного джерела. Невелике зниження балу за те, що деякі UI-специфічні стани (наприклад, `playerInputStore`) існують окремо, хоча це може бути виправдано для розділення відповідальності.

2.  **UDF (Unidirectional Data Flow):**
    *   **Оцінка: 90/100**
    *   **Обґрунтування:** Потік даних переважно односпрямований: `userActionService` -> `GameMode` -> `gameLogicService` -> `gameStateMutator` -> `gameState`. Це робить потік даних передбачуваним. Однак, іноді побічні ефекти (`sideEffectService`) та події (`gameEventBus`) можуть створювати менш очевидні потоки, що трохи ускладнює відстеження.

3.  **SoC (Separation of Concerns):**
    *   **Оцінка: 85/100**
    *   **Обґрунтування:** Дуже добре розділення відповідальності:
        *   `gameLogicService` (чиста логіка).
        *   `gameState` (стан).
        *   `gameStateMutator` (мутації стану).
        *   `GameMode` (оркестрація).
        *   Компоненти Svelte (UI).
    *   **Проблемні зони:** `BaseGameMode` містить занадто багато логіки, яка могла б бути винесена в окремі сервіси (наприклад, логіка завершення гри).

4.  **Композиція:**
    *   **Оцінка: 80/100**
    *   **Обґрунтування:** Компоненти добре структуровані, але є потенціал для кращої композиції. Наприклад, деякі великі компоненти можна було б розбити на менші та більш перевикористовувані.

5.  **Чистота та Побічні ефекти:**
    *   **Оцінка: 75/100**
    *   **Обґрунтування:** `gameLogicService` є переважно чистим, що є великим плюсом. Однак, `BaseGameMode` та `userActionService` містять багато побічних ефектів (робота з `tick`, `setTimeout`, анімаціями), які не завжди добре ізольовані. `sideEffectService` є кроком у правильному напрямку, але його використання можна розширити.

### Якість Коду та Реалізації

6.  **DRY (Don't Repeat Yourself):**
    *   **Оцінка: 80/100**
    *   **Обґрунтування:** Є дублювання коду, особливо в логіці перевірки доступних ходів, яка зустрічається в `BaseGameMode` та `gameLogicService`. Також є схожа логіка блокування вводу в `userActionService`.

7.  **Простота та Читабельність (KISS):**
    *   **Оцінка: 70/100**
    *   **Обґрунтування:** Код в цілому добре структурований, але деякі файли, як `BaseGameMode`, стали занадто великими та складними. Іменування змінних та функцій є зрозумілим.

8.  **Продуктивність:**
    *   **Оцінка: 85/100**
    *   **Обґрунтування:** Наразі проблем з продуктивністю не спостерігається. Використання `derived` сторів та реактивності Svelte є ефективним. Потенційні проблеми можуть виникнути при значному збільшенні розміру дошки або кількості гравців, але поточна архітектура є достатньо гнучкою для оптимізації.

9.  **Документація та Коментарі:**
    *   **Оцінка: 90/100**
    *   **Обґрунтування:** Коментарі в коді дуже корисні та пояснюють "навіщо", а не "що". Особливо цінні коментарі, що попереджають про можливі проблеми при рефакторингу.

## Частина 2: План покращення

### Пункти для покращення

-   [ ] **Рефакторинг `BaseGameMode`:** Винести логіку, що не стосується безпосередньо оркестрації ходу, в окремі сервіси (наприклад, `EndGameService`, `NoMovesService`).
-   [ ] **Централізація логіки доступних ходів:** Створити єдиний сервіс або утиліту, яка буде єдиним джерелом правди для визначення доступних ходів.
-   [ ] **Розширити використання `gameEventBus`:** Зменшити прямі виклики сервісів один з одного та замінити їх на систему подій, щоб зменшити зв'язаність.
-   [ ] **Ізоляція побічних ефектів:** Більш активно використовувати `sideEffectService` для всіх нечистих операцій (анімації, таймери, робота з DOM).
-   [ ] **Впровадження таймерів:** Створити `TimeService` для управління таймерами ходу гравця та загального часу гри.
-   [ ] **Створення `TimedGameMode`:** Розробити новий режим гри з обмеженням по часу на основі `VsComputerGameMode`.

### Список проблем та пріоритети

| Пріоритет (0-100) | Проблема                                                                                             | Рішення                                                                                                                                                             |
| ----------------- | ---------------------------------------------------------------------------------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **95**            | `BaseGameMode` занадто великий і порушує принцип єдиної відповідальності (SRP).                        | [ ] Рефакторинг `BaseGameMode`, винесення логіки в окремі сервіси.                                                                                                    |
| **90**            | Дублювання логіки визначення доступних ходів.                                                        | [ ] Створити `availableMovesService` або утиліту, яка буде єдиним джерелом правди.                                                                                    |
| **85**            | Висока зв'язаність між сервісами (`userActionService` напряму викликає `gameModeService` і т.д.).      | [ ] Розширити використання `gameEventBus` для комунікації між сервісами.                                                                                             |
| **80**            | Недостатня ізоляція побічних ефектів (таймери, анімації).                                             | [ ] Створити `TimeService` та більш активно використовувати `sideEffectService`.                                                                                      |
| **75**            | Відсутність архітектури для нових режимів гри з таймерами.                                            | [ ] Розробити `TimedGameMode` та інтегрувати `TimeService` в `BaseGameMode` для підтримки таймерів ходу.                                                               |
| **70**            | Потенційне порушення поділу відповідальності між UI та логікою гри.                                   | [ ] Провести аудит компонентів, щоб переконатися, що вони не містять ігрової логіки, а лише делегують дії до `userActionService`.                                       |

### Важливі зауваження

*   **Не зламати логіку:** Під час рефакторингу `BaseGameMode` та інших сервісів, необхідно ретельно тестувати, щоб не зламати існуючу логіку гри.
*   **Поділ відповідальності:** `game-board` (візуалізація) не повинна залежати від `center-info` (UI) та ігрової логіки. Ігрова логіка не повинна знати про візуалізацію. Цей принцип має бути збережений.
*   **Попередження в коді:** Всі коментарі-попередження в коді мають бути взяті до уваги.