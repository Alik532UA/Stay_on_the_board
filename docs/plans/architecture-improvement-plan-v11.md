# План покращення архітектури v11

Цей документ містить аналіз поточної архітектури та план дій для її покращення з метою підготовки до масштабування, зокрема до інтеграції онлайн-режиму гри.

## Частина 1: Комплексний аудит коду

### Архітектура та Структура

1.  **SSoT (Single Source of Truth):** `70/100`
    *   **Позитивно:** `gameState` є основним джерелом правди для логіки гри. `localGameStore` добре ізолює стан локальної гри.
    *   **Проблеми:** Існує кілька джерел, що впливають на стан. `settingsStore` може напряму змінювати `gameState` (наприклад, при ввімкненні `blockModeEnabled`), що порушує єдине джерело правди. Стан UI (`uiStore`, `modalStore`) існує окремо, що ускладнює повне відтворення стану гри.

2.  **UDF (Unidirectional Data Flow):** `60/100`
    *   **Позитивно:** В основному, потік даних іде від сторів до компонентів.
    *   **Проблеми:** Потік даних не завжди передбачуваний. `settingsStore` змінює `gameState`. `gameOrchestrator` викликає `gameLogicService`, який через `stateManager` змінює `gameState`, але також `gameOrchestrator` може напряму змінювати стан через `stateManager`. Це створює цикли та неочевидні залежності.

3.  **SoC (Separation of Concerns):** `50/100`
    *   **Позитивно:** `gameLogicService` містить чисті функції, що є хорошою практикою. `gameStore` та `localGameStore` мають чіткі зони відповідальності.
    *   **Проблеми:** `gameOrchestrator.ts` є "божественним об'єктом" (God Object). Він відповідає за ініціалізацію режимів, логіку кнопок, керування модальними вікнами, обробку ходів та взаємодію з UI. Це робить його складним для розуміння, тестування та модифікації. Логіка, пов'язана з UI (наприклад, `speakText`), перемішана з ігровою логікою.

4.  **Композиція:** `75/100`
    *   **Позитивно:** Використання Svelte компонентів для побудови UI є ефективним.
    *   **Проблеми:** Компоненти іноді напряму залежать від глобальних сторів (`get(gameState)`), що ускладнює їх перевикористання та тестування.

5.  **Чистота та Побічні ефекти:** `65/100`
    *   **Позитивно:** `gameLogicService` має багато чистих функцій.
    *   **Проблеми:** Побічні ефекти (робота з `localStorage` в `settingsStore`, маніпуляції з DOM, `goto` в `gameOrchestrator`) розпорошені по коду. `settingsStore` містить логіку, яка напряму впливає на ігровий стан, що є нечистою операцією.

### Якість Коду та Реалізації

6.  **DRY (Don't Repeat Yourself):** `80/100`
    *   **Позитивно:** Велика частина логіки винесена в сервіси та стори, що зменшує дублювання.
    *   **Проблеми:** Є невелике дублювання в логіці ініціалізації та скидання гри в різних режимах.

7.  **Простота та Читабельність (KISS):** `60/100`
    *   **Позитивно:** Іменування змінних та функцій в основному зрозуміле.
    *   **Проблеми:** `gameOrchestrator.ts` є надзвичайно складним. Велика кількість взаємозалежних сторів (`gameStore`, `gameState`, `localGameStore`, `settingsStore`, `playerInputStore`, `modalStore`) ускладнює відстеження потоку даних та розуміння, як зміна в одному місці вплине на інше.

8.  **Продуктивність:** `85/100`
    *   **Позитивно:** Використання реактивності Svelte є ефективним.
    *   **Проблеми:** Не виявлено критичних проблем, але велика кількість підписок на стори може призвести до зайвих перерендерів у складних сценаріях.

9.  **Документація та Коментарі:** `90/100`
    *   **Позитивно:** Код добре документований. Коментарі пояснюють *навіщо* і як працюють складні частини. Особливо важливі коментарі, що попереджають про потенційні проблеми при рефакторингу.

---

## Частина 2: План покращень

### Список проблем та пріоритети

| Пріоритет (0-100) | Проблема                                                              | Рішення                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    - |
|:---:|:---|:---|
|**100**|**Порушення SoC в `gameOrchestrator.ts`**| - [ ] **Декомпозиція `gameOrchestrator`:** Розділити його на менші, більш сфокусовані сервіси: `GameModeService` (керування життєвим циклом режимів), `UserActionService` (обробка дій користувача: кліки, хоткеї), `ModalService` (керування модальними вікнами). Це є **надважливим** для майбутньої інтеграції онлайн-режиму.|
|**95**|**Нечіткий потік даних (UDF)**| - [ ] **Впровадження Command Pattern:** Замість прямих викликів `stateManager` з різних місць, створити систему команд (наприклад, `MoveCommand`, `ChangeSettingsCommand`). `UserActionService` буде створювати команди, а єдиний `CommandHandler` буде їх виконувати, оновлюючи стан. Це зробить потік даних строго односпрямованим.|
|**90**|**Порушення SSoT через `settingsStore`**| - [ ] **Ізоляція `settingsStore`:** `settingsStore` не повинен напряму змінювати `gameState`. Замість цього, при зміні налаштувань, що впливають на гру (як `blockModeEnabled`), він має викликати відповідну команду (наприклад, `ToggleBlockModeCommand`), яка буде оброблена централізовано.|
|**85**|**Порушення ізоляції "center-info" та "game-board"**| - [ ] **Створення `derived` сторів для UI:** Створити `derived` стори, які будуть брати дані з `gameState` та трансформувати їх для конкретних UI компонентів. Наприклад, `boardViewStore` для `game-board` та `centerInfoViewStore` для `center-info`. Це гарантує, що UI залежить від стану, але не навпаки, і логіка гри не знає про візуалізацію.|
|**80**|**Надмірна складність через велику кількість сторів**| - [ ] **Об'єднання сторів:** Розглянути можливість об'єднання деяких сторів. Наприклад, `playerInputStore` може стати частиною `gameState`. `modalStore` може бути інтегрований в `uiState`.|
|**70**|**Побічні ефекти в сторах та компонентах**| - [ ] **Централізація побічних ефектів:** Створити `SideEffectService`, який буде відповідати за всі "нечисті" операції (`localStorage`, `fetch`, `goto`). Команди зможуть декларувати необхідні побічні ефекти, а сервіс буде їх виконувати.|
|**60**|**Пряма залежність компонентів від глобальних сторів**| - [ ] **Використання `props` та `context`:** Передавати необхідні дані в компоненти через `props` або `context` API Svelte замість прямого імпорту та виклику `get()` всередині компонентів. Це покращить їх перевикористання та тестування.|

### Надважливі завдання для збереження поточної логіки:

- [ ] **Ізоляція візуалізації дошки:** `game-board` має отримувати всі необхідні дані для рендерингу через `props` або спеціалізований `derived` стор (`boardViewStore`). Він не повинен містити ігрової логіки або напряму змінювати `gameState`.
- [ ] **Ізоляція ігрової логіки:** `gameLogicService` та `stateManager` не повинні мати жодних залежностей від UI компонентів або візуальних сторів.
- [ ] **Врахування коментарів:** Уважно перечитати всі коментарі в коді, що стосуються потенційних проблем при рефакторингу, і переконатися, що запропоновані зміни не ламають зазначену логіку.