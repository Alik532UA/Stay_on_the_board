# План Покращення Архітектури vUnited

**Статус:** Новий
**Дата:** 2025-07-24
**Мета:** Провести аудит поточної кодової бази, виявити слабкі місця та розробити покроковий план рефакторингу. Основний фокус — підготовка архітектури до масштабування та додавання нових ігрових режимів ("Локальна гра", "Гра онлайн").

## 1. SSoT (Single Source of Truth) - Єдине Джерело Правди

**Проблема:** Стан гри розпорошений між кількома сторами (`gameState`, `playerInputStore`, `animationStore`), що ускладнює керування, синхронізацію та може призвести до помилок.

-   [ ] **Об'єднати ключові ігрові стори в єдиний `gameStore`.**
    -   [ ] Створити новий стор `gameStore.ts`.
    -   [ ] Розробити для нього TypeScript-інтерфейс, що чітко розділяє:
        -   `SharedState`: дані, що синхронізуються між гравцями (стан дошки, рахунок, поточний хід).
        -   `UIState`: локальні дані для кожного гравця (вибраний напрямок, стан анімації, налаштування інтерфейсу).
    -   [ ] Перенести логіку та дані з `gameState`, `playerInputStore` у новий `gameStore`.
    -   [ ] Ліквідувати `animationStore`, перенісши його логіку безпосередньо в UI-компоненти, які будуть реагувати на зміни в `gameStore`. Анімація — це відповідальність UI, а не стану.
-   [ ] **Централізувати збереження/відновлення стану.** Створити `storageService.js` для інкапсуляції всієї логіки роботи з `localStorage`.

## 2. UDF (Unidirectional Data Flow) - Односпрямований Потік Даних

**Проблема:** Хоча потік даних переважно односпрямований, є місця, де компоненти можуть напряму змінювати стан, минаючи централізовані дії.

-   [ ] **Формалізувати потік дій через `gameActions.ts`.**
    -   [ ] Встановити правило: усі зміни ігрового стану (`gameStore`) повинні відбуватися виключно через виклик функцій з `gameActions.ts`.
    -   [ ] Провести ревізію коду на предмет прямих викликів `.update()` або `.set()` для ігрових сторів з UI-компонентів та перенести цю логіку в `gameActions`.
-   [ ] **Ізолювати побічні ефекти.**
    -   [ ] Усі побічні ефекти (таймери, аудіо, API-запити для онлайн-режиму) мають ініціюватися виключно з `gameActions`, а їх виконання делегуватися відповідним сервісам.

## 3. SoC (Separation of Concerns) - Розділення Відповідальностей

**Проблема:** Деякі модулі та компоненти мають забагато відповідальностей (`gameOrchestrator.js`, `GameBoard.svelte`).

-   [ ] **Розвантажити `gameOrchestrator.js`.**
    -   [ ] Логіку ходу комп'ютера (`triggerComputerMove`) повністю перенести в `playerAgents.js`.
    -   [ ] Логіку завершення гри та показу модальних вікон винести в окремий `uiService.js`, який буде взаємодіяти з `modalService`.
-   [ ] **Винести логіку з компонентів.**
    -   [ ] Логіку визначення стану центральної кнопки (`centerInfoState`) з `ControlsPanelWidget.svelte` перенести у `derived` стор, що базується на `gameStore`.
    -   [ ] Логіку обробки результатів гри (реакцію на `$gameState.isGameOver`) з `GameBoard.svelte` перенести в `uiService.js`.
-   [ ] **Створити чіткі сервіси.**
    -   [ ] `audioService.js`: керування всіма звуковими ефектами та музикою.
    -   `hotkeyService.js`: централізована обробка гарячих клавіш.
    -   `modalService.js`: керування всіма модальними вікнами (вже існує, потребує доопрацювання).

## 4. Композиція

**Проблема:** Є можливість для кращого перевикористання компонентів.

-   [ ] **Створити універсальний компонент для плаваючих кнопок.**
    -   [ ] Об'єднати `FloatingBackButton.svelte` та `FloatingCloseButton.svelte` в один компонент `FloatingButton.svelte` з пропсами для іконки, дії (`onClick`) та позиції.
-   [ ] **Зробити віджети максимально "дурними" (dumb components).**
    -   [ ] Віджети (`TopRowWidget`, `ScorePanelWidget` тощо) не повинні містити складної логіки. Вони мають отримувати дані через пропси та повідомляти про дії через події (`dispatch`).

## 5. Чистота та Побічні ефекти

**Проблема:** Побічні ефекти (робота з `localStorage`, `window`) не завжди централізовані.

-   [ ] **Ізолювати всі побічні ефекти в спеціалізовані сервіси.**
    -   [ ] Створити `storageService.js` для інкапсуляції всієї логіки читання/запису в `localStorage`.
    -   [ ] Створити `audioService.js` для керування `new Audio()`.
    -   [ ] Запланувати `apiService.js` для майбутньої роботи з мережею в онлайн-режимі.

## 6. DRY (Don't Repeat Yourself)

**Проблема:** Є дублювання коду в CSS та логіці обробки хоткеїв.

-   [ ] **Провести аудит CSS.** Знайти та усунути дублювання стилів, які не покриваються існуючими змінними, створивши нові утилітарні класи або CSS-змінні.
-   [ ] **Уніфікувати логіку обробки хоткеїв.**
    -   [ ] Створити єдиний сервіс `hotkeyService.js`, який буде слухати події `keydown` на рівні `window` і викликати відповідні дії з `gameActions`.
    -   [ ] Видалити обробники `on:keydown` з окремих компонентів.
-   [ ] **Централізувати константи.**
    -   [ ] Створити файл `src/lib/constants.ts` для ігрових констант (напрямки, бонуси, ліміти розміру дошки тощо).

## 7. KISS (Keep It Simple, Stupid)

**Проблема:** Велика кількість сторів та складний `gameOrchestrator` ускладнюють розуміння потоку даних.

-   [ ] **Спростити структуру стану.** Після об'єднання сторів (пункт 1), архітектура стане значно простішою для розуміння.
-   [ ] **Рефакторинг `gameOrchestrator.js`.** Після розвантаження (пункт 3), його роль стане прозорішою — координація між сервісами.
-   [ ] **Покращити іменування.** Провести ревізію назв змінних, функцій та файлів, щоб вони краще відображали їхню суть.

## 8. Продуктивність

**Проблема:** Потенційні зайві перерендери через надмірні підписки та неоптимальні анімації.

-   [ ] **Оптимізувати реактивність.**
    -   [ ] Перевірити всі `$derived` та `derived()` на наявність зайвих залежностей.
    -   [ ] Використовувати `untrack` там, де не потрібна реактивність на зміну певного значення.
-   [ ] **Проаналізувати анімації.**
    -   [ ] Переконатися, що анімації руху ферзя та зникнення дошки використовують CSS-трансформації (`transform`, `opacity`), а не властивості, що викликають перерахунок макета (`width`, `height`).
-   [ ] **Оптимізувати синхронізацію для онлайн-режиму (на майбутнє).**
    -   [ ] При проектуванні `gameStore` передбачити можливість надсилати лише диференційовані зміни (diffs) стану, а не весь об'єкт.

## 9. Документація та Коментарі

**Проблема:** Документація неповна та не завжди пояснює причини прийнятих рішень.

-   [ ] **Впровадити та дотримуватись стандарту JSDoc.**
    -   [ ] Додати JSDoc-коментарі до всіх ключових функцій, сторів, їх властивостей та типів.
-   [ ] **Створити `ARCHITECTURE.md`.**
    -   [ ] Описати в ньому основні принципи (SSoT, UDF, SoC), структуру `gameStore`, потік даних та взаємодію ключових сервісів.
-   [ ] **Коментарі повинні пояснювати "навіщо", а не "що".**
    -   [ ] Пройтися по існуючих коментарях та оновити їх, видаливши застарілі та додавши пояснення для складних або неочевидних рішень.