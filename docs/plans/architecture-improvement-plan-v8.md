# План Покращення Архітектури v8

Цей документ містить комплексний аудит поточної кодової бази та пріоритезований план покращень для підготовки додатку до майбутнього масштабування, зокрема додавання нових ігрових режимів, як-от "Гра Онлайн".

## Частина 1: Аудит Коду

Ось комплексний аудит коду на основі зазначених критеріїв.

### Архітектура та Структура

1.  **SSoT (Single Source of Truth):** 75/100
    *   **Позитивно:** Ключовий стан гри централізовано в `gameState.ts`, що є чудовим рішенням. Використання похідних сторів (`derivedState.ts`) для специфічних станів UI, як-от `visualPosition`, є сильним патерном, що запобігає дублюванню стану.
    *   **Напрямки для покращення:** Присутність `localGameStore` поруч із `gameState` створює певну складність. `gameOrchestrator` змушений читати дані з обох джерел для визначення результатів гри, що дещо розмиває межі єдиного джерела правди, особливо для даних гравців та їхніх рахунків у різних режимах гри.

2.  **UDF (Unidirectional Data Flow):** 85/100
    *   **Позитивно:** Потік даних загалом односпрямований: події в UI викликають дії в `gameOrchestrator`, який звертається до `gameLogicService`, що оновлює стор `gameState`. Потім UI реагує на зміни в сторі. Це надійна реалізація UDF.
    *   **Напрямки для покращення:** `gameOrchestrator` — це дуже великий файл, що виконує багато обов'язків, включно зі складною логікою UI (побудова модальних вікон). Це ускладнює відстеження потоку даних, ніж якби логіка була більш модульною.

3.  **SoC (Separation of Concerns):** 70/100
    *   **Позитивно:** Існує гарний поділ між чистою ігровою логікою (`gameLogicService.ts`) та компонентами UI. Використання окремого `animationStore` для відокремлення візуальних ефектів від ігрової логіки є значною перевагою, як зазначено в коментарях до `BoardWrapperWidget.svelte`.
    *   **Напрямки для покращення:** `gameOrchestrator.ts` перетворився на "божественний об'єкт". Він керує переходами стану гри, введенням гравця, ходами ШІ, створенням контенту модальних вікон та навігацією. Це порушує SoC і робить компонент складним для підтримки та тестування. Логіка для обробки різних режимів гри (локальна проти ШІ) переплетена в одних і тих же функціях (`endGame`, `_advanceToNextPlayer`).

4.  **Композиція:** 90/100
    *   **Позитивно:** UI ефективно побудований з менших, повторно використовуваних Svelte-компонентів (віджетів). `DraggableColumns` та лейаут на основі віджетів (`layoutStore`) забезпечують чудову гнучкість.
    *   **Напрямки для покращення:** Значних проблем не виявлено. Композиція компонентів є сильною стороною архітектури.

5.  **Чистота та Побічні ефекти:** 65/100
    *   **Позитивно:** `gameLogicService.ts` містить переважно чисті функції для обчислень, що чудово для тестування та передбачуваності.
    *   **Напрямки для покращення:** `gameOrchestrator.ts` є основним джерелом побічних ефектів (навігація, модальні вікна, sessionStorage, виклики ШІ), і вони сильно перемішані з бізнес-логікою. Це ускладнює розуміння коду. Наприклад, `endGame` обчислює рахунки, визначає переможців, будує контент модального вікна, а потім показує його.

### Якість Коду та Реалізації

6.  **DRY (Don't Repeat Yourself):** 70/100
    *   **Позитивно:** Основні обчислення та утиліти добре абстраговані (`boardUtils.ts`, `gameLogicService.ts`).
    *   **Напрямки для покращення:** У `gameOrchestrator.ts` є значне дублювання коду для обробки сценаріїв "немає ходів" як для гравця, так і для комп'ютера. Логіка створення модальних вікон для цих двох випадків майже ідентична. Логіка визначення переможця також повторюється між `endGame` та функцією `afterNavigate` у `local/+page.svelte`.

7.  **Простота та Читабельність (KISS):** 60/100
    *   **Позитивно:** Окремі компоненти та сервіси загалом зрозумілі та добре прокоментовані.
    *   **Напрямки для покращення:** Файл `gameOrchestrator.ts` має понад 1000 рядків, а функції на кшталт `endGame` — сотні рядків. Ця складність робить код дуже важким для розуміння, налагодження та розширення. Логіка є вкладеною та умовною, що ускладнює відстеження потоку для конкретного режиму гри.

8.  **Продуктивність:** 85/100
    *   **Позитивно:** Використання похідних сторів допомагає мінімізувати непотрібні перерендери. Відокремлення логіки анімації від оновлень стану гри є вирішальним для хорошої продуктивності.
    *   **Напрямки для покращення:** З огляду коду значних проблем із продуктивністю не виявлено, але складність оркестратора потенційно може призвести до неефективності з додаванням нових функцій.

9.  **Документація та Коментарі:** 95/100
    *   **Позитивно:** Код винятково добре прокоментований. Коментарі пояснюють "навіщо" за архітектурними рішеннями (наприклад, коментарі в `BoardWrapperWidget.svelte` про SoC). Це величезний плюс для підтримки.

## Частина 2: План Покращень

Цей план пріоритезує завдання для вирішення проблем, виявлених під час аудиту, з метою підготовки кодової бази до масштабування.

### Пріоритезований Список Завдань

- [x] **Рефакторинг `gameOrchestrator` у модульну архітектуру на основі режимів.** (Пріоритет: 100)
    *   **Проблема:** Оркестратор є "божественним об'єктом", що порушує SoC і є складним для підтримки.
    *   **Рішення:** Створити інтерфейс `GameMode` та окремі реалізації для `LocalGameMode`, `VsComputerGameMode` та майбутнього `OnlineGameMode`. Оркестратор делегуватиме всю специфічну для режиму логіку (обробка ходів, завершення гри, визначення переможців) активному екземпляру режиму гри. Це кардинально спростить оркестратор і зробить додавання нових режимів тривіальним.

- [x] **Консолідація управління станом гравців та рахунку.** (Пріоритет: 90)
    *   **Проблема:** Стан для локальних ігор розділений між `gameState` та `localGameStore`, що призводить до складної логіки для обчислення рахунку та переможця.
    *   **Рішення:** Провести рефакторинг стану таким чином, щоб `gameState` був єдиним джерелом правди для всіх активних гравців та їхніх рахунків, незалежно від режиму гри. `localGameStore` слід використовувати лише для налаштування нової локальної гри (на екрані налаштувань), а не для управління станом під час активного ігрового процесу.

- [X] **Ізоляція побічних ефектів від основної логіки.** (Пріоритет: 85)
    *   **Проблема:** Побічні ефекти (модальні вікна, навігація) перемішані з бізнес-логікою в оркестраторі.
    *   **Рішення:** Створити виділені сервіси для взаємодії з UI. Наприклад, `modalService` може відповідати за побудову та показ усіх модальних вікон, пов'язаних з грою, приймаючи кінцевий стан гри як вхідні дані. Оркестратор просто викликатиме `modalService.showGameOverModal(finalState)` замість того, щоб будувати модальне вікно самостійно.

- [X] **Рефакторинг логіки "Немає ходів" для усунення повторень (DRY).** (Пріоєитет: 75)
    *   **Проблема:** Логіка для обробки сценарію "немає доступних ходів" дублюється для гравця та комп'ютера.
    *   **Рішення:** Створити єдину, повторно використовувану функцію `handleNoMoves(playerType: 'human' | 'ai')`, яку можна викликати з активного режиму гри. Ця функція міститиме спільну логіку для нарахування бонусів та показу відповідного модального вікна.

- [X] **Відокремлення ігрової логіки від компонентів UI.** (Пріоритет: 70)
    *   **Проблема:** Компонент `local/+page.svelte` містить логіку для повторного відображення модального вікна завершення гри після перегляду повтору. Ця логіка тісно пов'язана з UI та дублює обчислення переможця.
    *   **Рішення:** Цю логіку слід перенести в оркестратор або у виділений сервіс. Компонент сторінки має бути "дурним" і відповідати лише за відображення того, що йому передають стори. Оркестратор повинен керувати всім життєвим циклом гри, включно з поверненням з перегляду повтору.
