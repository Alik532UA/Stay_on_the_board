# Тип: План
# Статус: Новий
# Назва: План покращення архітектури v13
# Мета: Провести аудит поточної архітектури, виявити слабкі місця та сформувати пріоритетний план дій для підготовки кодової бази до масштабування, зокрема до реалізації онлайн-режиму.

---

## Частина 1: Комплексний аудит коду

На основі аналізу ключових сервісів та сторів (`gameModeService`, `stateManager`, `gameState`, `BaseGameMode`, `sideEffectService`) було проведено аудит поточної архітектури.

### Архітектура та Структура

1.  **SSoT (Single Source of Truth):**
    *   **Оцінка: 75/100**
    *   **Добре:** `gameState` стає центральним джерелом правди, що є великим плюсом.
    *   **Проблеми:** Залишається розсіяний стан (`playerInputStore`, `animationStore`, `settingsStore`). `stateManager` як єдиний мутатор стану використовується не завжди, є прямі виклики `store.update`.

2.  **UDF (Unidirectional Data Flow):**
    *   **Оцінка: 80/100**
    *   **Добре:** Потік даних переважно односпрямований (`Дія -> Сервіс -> GameMode -> Зміна стану`). `sideEffectService` чудово реалізує повернення побічних ефектів з логіки до UI.
    *   **Проблеми:** Деякі компоненти можуть створювати складні похідні стани.

3.  **SoC (Separation of Concerns):**
    *   **Оцінка: 85/100**
    *   **Добре:** Чітке розділення: `services` (логіка), `stores` (стан), `gameModes` (правила режимів). `sideEffectService` є ідеальним прикладом ізоляції побічних ефектів.
    *   **Проблеми:** `BaseGameMode` все ще містить логіку, пов'язану з UI (`createGameOverModalContent`), що зв'язує його з конкретною реалізацією модального вікна.

4.  **Композиція:**
    *   **Оцінка: 70/100**
    *   **Добре:** Використання класів `GameMode` з наслідуванням від `BaseGameMode` є гарним прикладом композиції та патерну "Стратегія".
    *   **Проблеми:** Оцінка стосується переважно логіки, а не UI-компонентів.

5.  **Чистота та Побічні ефекти:**
    *   **Оцінка: 90/100**
    *   **Добре:** `sideEffectService` — це найкраще архітектурне рішення в проєкті, що ідеально ізолює "брудні" операції.
    *   **Проблеми:** Основний ризик — розробники можуть ігнорувати сервіс і викликати `goto()` або `modalStore.show()` напряму з логіки.

### Якість Коду та Реалізації

6.  **DRY (Don't Repeat Yourself):**
    *   **Оцінка: 80/100**
    *   **Добре:** `BaseGameMode` усуває багато дублювання між режимами гри.
    *   **Проблеми:** У `gameModeService` майже в кожній функції повторюється логіка "отримати або ініціалізувати ігровий режим".

7.  **Простота та Читабельність (KISS):**
    *   **Оцінка: 65/100**
    *   **Добре:** Структура файлів та папок логічна. Нещодавній рефакторинг `scoreService` покращив читабельність.
    *   **Проблеми:** `stateManager` є надто складним. Його логіка валідації завелика, а відкладений імпорт `gameState` може вказувати на циклічні залежності.

8.  **Продуктивність:**
    *   **Оцінка: 60/100**
    *   **Проблеми:** Монолітний стор `gameState` може викликати проблеми з продуктивністю через зайві перерендери компонентів. Часте використання `get()` всередині компонентів (якщо таке є) може бути неефективним.

9.  **Документація та Коментарі:**
    *   **Оцінка: 70/100**
    *   **Добре:** JSDoc-коментарі присутні в ключових файлах.
    *   **Проблеми:** Коментарі не завжди пояснюють "навіщо". Відсутня високорівнева архітектурна документація.

---

## Частина 2: План покращення архітектури

### Надважливі правила рефакторингу:
- **Золоте правило:** Візуалізація дошки (`game-board`) НІКОЛИ не повинна впливати на `center-info` та логіку гри. Логіка гри та `center-info` НІЧОГО не знають про існування візуальної дошки.
- **Увага до коментарів:** Враховувати існуючі попередження в коді щодо логіки, яка може зламатися.

### Список завдань для покращення

- [x] **Крок 1: Рефакторинг `gameModeService` (Важливість: 95)**
  - [x] Винести повторювану логіку `if (!activeGameMode) this.initializeGameMode()` в приватний метод-хелпер, щоб усунути дублювання коду (DRY).
  - **Ціль:** Спростити сервіс, покращити читабельність та підтримку.

- [x] **Крок 2: Декомпозиція `BaseGameMode` (Важливість: 90)**
  - [x] Прибрати метод `createGameOverModalContent` з `BaseGameMode`.
  - [x] `BaseGameMode` має повертати лише чисті дані про результат гри.
  - [x] Створити окремий сервіс або UI-хелпер, який буде відповідати за створення контенту модального вікна на основі цих даних.
  - **Ціль:** Повністю розділити логіку гри від її представлення (SoC), що є критичним для додавання нових платформ або UI.

- [x] **Крок 3: Спрощення `stateManager` (Важливість: 85)**
  - [x] Проаналізувати та усунути причину відкладеного імпорту `gameState`, щоб позбутися потенційної циклічної залежності.
  - [x] Розглянути можливість винесення логіки валідації з `stateManager` ближче до модулів, які володіють відповідною частиною стану.
  - **Ціль:** Зменшити складність, підвищити прозорість та надійність оновлень стану.

- [ ] **Крок 4: Оптимізація управління станом (Важливість: 80)**
  - [ ] Розглянути можливість розділення монолітного `gameState` на більш гранулярні стори (наприклад, `boardStore`, `playersStore`, `gameStatusStore`).
  - [ ] Активніше використовувати похідні стори (`derived`) для обчислюваних даних (наприклад, `isGameOver`), щоб уникнути зайвих перерендерів.
  - **Ціль:** Підвищити продуктивність та оптимізувати реактивність системи.

- [ ] **Крок 5: Створення високорівневої архітектурної документації (Важливість: 70)**
  - [ ] Створити файл `docs/architecture.md`.
  - [ ] Описати в ньому ключові архітектурні патерни, що використовуються в проєкті (SSoT, UDF, `sideEffectService`).
  - [ ] Додати схему взаємодії основних сервісів та сторів.
  - [ ] Сформулювати "золоті правила" розробки для цього проєкту.
  - **Ціль:** Полегшити онбординг нових розробників та забезпечити консистентність коду при подальшому масштабуванні.