# План Покращення Архітектури v1

**Головна мета:** Підготувати кодову базу до масштабування (нові ігрові режими), посилити розділення відповідальностей (SoC) та забезпечити чіткий, односпрямований потік даних (UDF).

**Ключовий принцип:** Візуалізація (`GameBoard`) є лише пасивним спостерігачем за станом гри. Вона ніколи не повинна напряму впливати на логіку або інші UI-елементи. Всі зміни стану ініціюються виключно через дії користувача, які обробляються централізованим оркестратором.

---

### 1. Посилення Єдиного Джерела Правди (SSoT)

*Оцінка: 75/100. Мета: централізувати логічний стан гри в `gameState` і зробити інші стори похідними або чистою UI-репрезентацією.*

- [ ] **Рефакторинг `playerInputStore`:**
    - [ ] Видалити `lastComputerMove`. Ця інформація є в `gameState.moveHistory`.
    - [ ] Створити `derived` стор `lastComputerMove` з `gameState`, щоб `GameControls` міг на нього реагувати. Це прибере дублювання.
    - [ ] `playerInputStore` повинен містити лише тимчасовий стан вводу гравця (`selectedDirection`, `selectedDistance`).

- [ ] **Рефакторинг `animationStore`:**
    - [ ] Перетворити `animationStore` на сервіс, який *тільки читає* з `gameState.moveQueue`.
    - [ ] `animationStore` повинен мати власний внутрішній стан (`visualRow`, `visualCol`), який він оновлює з затримками, але він **ніколи** не повинен записувати дані назад у `gameState`.
    - [ ] `BoardWrapperWidget` повинен залежати **тільки** від `animationStore` для позиції ферзя та стану клітинок, а не напряму від `gameState`.

- [ ] **Створити `derived` стор для `center-info`:**
    - [ ] Створити новий `derived` стор, який залежить від `gameState` та `playerInputStore`.
    - [ ] Цей стор буде містити всю логіку з `GameControls.svelte` (`centerInfoState`), щоб визначати, що показувати: хід комп'ютера, вибір гравця чи порожній рядок. Це спростить компонент `GameControls`.

---

### 2. Формалізація Односпрямованого Потоку Даних (UDF)

*Оцінка: 80/100. Мета: створити чіткий та єдиний шлях для зміни стану, усунувши можливість race conditions.*

- [ ] **Централізація логіки в `GameOrchestrator`:**
    - [ ] Перетворити `gameOrchestrator.js` на повноцінний клас або сервіс, який ініціалізується один раз.
    - [ ] Всі дії гравця з `GameControls` (`confirmPlayerMove`, `claimNoMoves`) повинні викликати методи цього оркестратора.
    - [ ] Оркестратор буде відповідальним за послідовність:
        1. Виклик дії з `gameActions` для оновлення `gameState`.
        2. Запуск ходу комп'ютера (асинхронно).
        3. Виклик дії для оновлення `gameState` після ходу комп'ютера.
    - [ ] Побічні ефекти (озвучення) повинні викликатися з оркестратора, а не з `gameActions`.

- [ ] **Розділення `gameActions.ts`:**
    - [ ] `gameActions.ts` повинен містити **тільки** функції, які приймають поточний стан та повертають новий (чисті мутації).
    - [ ] Винести логіку, яка залежить від кількох сторів або має побічні ефекти, в `GameOrchestrator`.

---

### 3. Посилення Розділення Відповідальностей (SoC)

*Оцінка: 70/100. Мета: зробити компоненти "тупішими", а логіку винести в спеціалізовані сервіси/стори.*

- [ ] **Створити `GameLogicService`:**
    - [ ] Об'єднати чисті функції з `gameCore.ts` та функції-мутації з `gameActions.ts` в єдиний сервіс. Це буде єдине місце, де знаходиться вся ігрова логіка.

- [ ] **Винести логіку з компонентів:**
    - [ ] `GameControls.svelte`: вся логіка визначення стану кнопок та центрального дисплея має бути в `derived` сторах. Компонент лише відображає стан та викликає дії оркестратора.
    - [ ] `MainMenu.svelte`: логіку показу модальних вікон (`showGameModeModal`) винести в `uiService` або подібний модуль, який буде викликатися при навігації на `/game`.

- [ ] **Ізолювати побічні ефекти:**
    - [ ] Створити `AudioService` (`audioStore.js` вже є, але його треба формалізувати як сервіс), який буде відповідати за програвання звуків. `GameOrchestrator` буде викликати його методи.
    - [ ] Створити `NavigationService` (`navigation.js` вже є), який буде централізовано обробляти всі `goto()` та `history.back()`.

---

### 4. Покращення Якості Коду та Документації

*Оцінки: DRY (75), KISS (80), Docs (70). Мета: зробити код більш підтримуваним та зрозумілим.*

- [ ] **Рефакторинг дублювання:**
    - [ ] Створити хелпер-функцію або сервіс для керування логікою ігрових режимів (`applyGameModePreset`), щоб уникнути дублювання в `MainMenu` та `GameModeModal`.

- [ ] **Спрощення реактивності:**
    - [ ] Проаналізувати всі `$: ` блоки. Якщо логіка складна, винести її в `derived` стор.

- [ ] **Документація:**
    - [ ] Створити файл `ARCHITECTURE.md` в корені проєкту або в папці `docs`.
    - [ ] Описати в ньому основні стори, сервіси та їхню взаємодію. Показати на схемі потік даних (UDF).
    - [ ] Додати JSDoc-коментарі до всіх ключових функцій та сторів, описуючи їх призначення.