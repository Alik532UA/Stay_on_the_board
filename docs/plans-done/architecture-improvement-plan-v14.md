# План Покращення Архітектури v14

Цей документ містить аналіз поточної архітектури кодової бази та пропонує план дій для її підготовки до масштабування, зокрема до впровадження нового ігрового режиму "Гра онлайн".

## Частина 1: Комплексний Аудит Коду

Нижче наведено оцінку архітектури за ключовими критеріями. Оцінка виставляється за шкалою від 0 до 100.

### Архітектура та Структура

- [ ] **SSoT (Single Source of Truth): 95/100**
  - **Обґрунтування:** Стан гри чітко централізовано в `gameState`. Інші аспекти стану (налаштування, ввід користувача) ізольовані у власних сторах (`appSettingsStore`, `playerInputStore`). Похідні дані ефективно обчислюються в `derivedState.ts`, що відповідає найкращим практикам Svelte. Це майже ідеальна реалізація SSoT.

- [ ] **UDF (Unidirectional Data Flow): 95/100**
  - **Обґрунтування:** Потік даних чітко односпрямований. UI-компоненти (`ControlsPanelWidget`) викликають дії в сервісах (`userActionService`), які, в свою чергу, викликають чисті функції в `gameLogicService` для мутації стану. Стан оновлюється, і UI реактивно на це реагує. Цей підхід мінімізує непередбачувані зміни стану.

- [ ] **SoC (Separation of Concerns): 90/100**
  - **Обґрунтування:** Відповідальності добре розділені:
    - **Стан:** `gameState` та інші стори.
    - **Логіка:** `gameLogicService` (чисті функції), `gameModeService` (оркестрація режимів).
    - **UI:** Компоненти-віджети (`BoardWrapperWidget`, `GameInfoWidget`).
    - **Візуалізація:** `animationStore` повністю відокремлює логіку анімації від логіки гри, що є надзвичайно важливим і добре реалізованим.

- [ ] **Композиція: 90/100**
  - **Обґрунтування:** Архітектура на основі віджетів дозволяє ефективно будувати UI. Компоненти, такі як `BoardWrapperWidget`, є самодостатніми і взаємодіють зі сторами, а не один з одним напряму, що сприяє низькій зв'язаності.

- [ ] **Чистота та Побічні ефекти: 85/100**
  - **Обґрунтування:** `gameLogicService` містить переважно чисті функції, що є великим плюсом. Побічні ефекти (показ модальних вікон, аудіо) винесені в `sideEffectService`. Цю систему можна зробити ще більш формалізованою, але поточна реалізація вже є дуже хорошою.

### Якість Коду та Реалізації

- [ ] **DRY (Don't Repeat Yourself): 90/100**
  - **Обґрунтування:** Використання `BaseGameMode` є чудовим прикладом уникнення дублювання коду між різними ігровими режимами (`VsComputerGameMode`, `LocalGameMode`). Це створює надійний шаблон для майбутнього розширення.

- [ ] **Простота та Читабельність (KISS): 95/100**
  - **Обґрунтування:** Код добре структурований, назви файлів та функцій є інтуїтивно зрозумілими. Використання TypeScript значно покращує читабельність та надійність. Розбиття на невеликі, сфокусовані модулі (стори, сервіси, віджети) робить код легким для розуміння.

- [ ] **Продуктивність: 90/100**
  - **Обґрунтування:** Використання `derived` сторів для обчислення похідних даних є оптимальним з точки зору продуктивності. Відокремлення анімації від логіки гри запобігає блокуванню стану під час візуальних ефектів.

- [ ] **Документація та Коментарі: 100/100**
  - **Обґрунтування:** Код містить виняткові коментарі. Вони пояснюють не *що* робить код, а *навіщо* були прийняті ті чи інші архітектурні рішення. Це безцінно для підтримки та майбутнього розвитку проєкту. Особливо важливі коментарі, що попереджають про потенційні проблеми при рефакторингу.

---

## Частина 2: План Покращень для Масштабування

Мета: підготувати архітектуру до реалізації режиму "Гра онлайн".

### Список Завдань (пріоритет від 100 до 0)

- [x] **(100) Формалізувати систему обробки дій та подій.**
  - **Проблема:** Поточна система, де сервіси повертають `SideEffect[]`, добре працює для локальної гри, але може бути недостатньо надійною для мережевої взаємодії.
  - **Рішення:** Створити централізовану шину подій або чергу команд (`Command Queue`). `userActionService` має перетворювати дії користувача на команди. Це дозволить обробляти команди з різних джерел (локальний UI, мережа, система повторів) однаково.
  - **Важливість:** Критично для розділення вводу користувача від ігрової логіки.

- [x] **(95) Створити абстракцію для джерела вводу.**
  - **Проблема:** Зараз дії гравця надходять безпосередньо з UI (`ControlsPanelWidget`). В онлайн-грі дії опонента надходитимуть з мережі.
  - **Рішення:** Модифікувати `userActionService`, щоб він не залежав від UI. Створити "провайдерів вводу" (Input Providers), які б транслювали події (клік кнопки, мережевий пакет) у стандартизовані команди для `userActionService`.
  - **Важливість:** Необхідно, щоб логіка гри не знала, звідки прийшла команда на хід.

- [x] **(90) Створити `OnlineGameMode`.**
  - **Проблема:** Потрібна інкапсуляція логіки, специфічної для онлайн-гри.
  - **Рішення:** За аналогією з існуючими режимами, створити клас `OnlineGameMode extends BaseGameMode`. Цей клас буде відповідати за відправку ходів на сервер, отримання ходів опонента та обробку мережевих подій (наприклад, розрив з'єднання).
  - **Важливість:** Дотримання існуючої архітектури для чистоти та розширюваності коду.

- [x] **(80) Розробити механізм синхронізації та звірки стану.**
  - **Проблема:** В онлайн-грі стан клієнта може розсинхронізуватися зі станом сервера.
  - **Рішення:** Реалізувати механізм, за допомогою якого гра періодично або за запитом отримує авторитетний стан від сервера і м'яко коригує локальний `gameState`. Це може включати в себе порівняння історії ходів.
  - **Важливість:** Забезпечення консистентності гри для всіх гравців.

- [x] **(60) Ізолювати мутації `gameState` в одному місці.**
  - **Проблема:** Хоча `gameLogicService` є основним мутатором, деякі зміни стану (наприклад, `currentPlayerIndex`) відбуваються в `BaseGameMode`.
  - **Рішення:** Розглянути можливість створення єдиного "мутатора" або сервісу, який би був єдиною точкою входу для всіх змін `gameState`. `gameLogicService` міг би повертати не просто результат, а об'єкт "зміни стану", який би застосовувався цим центральним мутатором.
  - **Важливість:** Підвищення передбачуваності та полегшення налагодження, особливо в асинхронному мережевому середовищі.

- [ ] **(40) Розширити `testModeStore` для симуляції мережевих умов.**
  - **Проблема:** Розробка та тестування онлайн-режиму ускладнюється через непередбачуваність мережі.
  - **Рішення:** Додати в `testModeStore` можливість симулювати затримку (latency) та втрату пакетів для тестування стійкості `OnlineGameMode` та логіки синхронізації.
  - **Важливість:** Значно прискорить розробку та підвищить якість онлайн-режиму.