# План покращення архітектури v28

## Частина 1: Комплексний аудит коду

На основі аналізу ключових файлів (`gameStore.ts`, `playerStore.ts`, `boardStore.ts`, `scoreStore.ts`, `uiStateStore.ts`, `derivedState.ts`, `gameLogicService.ts`, `gameService.ts`, `userActionService.ts`, `gameOrchestrator.ts`) було проведено аудит архітектури.

| Критерій | Оцінка (0-100) | Коментар |
| :--- | :--- | :--- |
| **SSoT (Single Source of Truth)** | 70 | Основа на Svelte stores є міцною, але існує потенціал для дублювання стану між різними сховищами (наприклад, `gameStore`, `playerStore`). Відносини між даними не завжди чітко визначені, що може призвести до неузгодженості. |
| **UDF (Unidirectional Data Flow)** | 75 | Потік даних в цілому є односпрямованим (UI -> сервіс -> сховище -> UI). Однак, використання `subscribe` всередині сервісів (`gameOrchestrator`) для реакції на зміни стану може ускладнити відстеження потоку та створити неочевидні залежності. |
| **SoC (Separation of Concerns)** | 65 | Існує хороший поділ на сховища (стан), сервіси (логіка) та компоненти (UI). Проте, відповідальність між `gameService` та `gameOrchestrator` частково збігається. Існує ризик проникнення логіки відображення в ігрову логіку, що є критичним моментом. |

---

## Частина 2: План покращення

### Надважливі завдання (Неухильно дотримуватися)

- [ ] **Ізоляція логіки та візуалізації:** Провести повний аудит взаємодії між `game-board` (та іншими візуальними компонентами) та сервісами ігрової логіки.
    - `game-board` **не повинен** напряму викликати функції `gameLogicService` або змінювати стан гри. Всі дії користувача мають проходити через `userActionService`.
    - `center-info` та ігрова логіка **не повинні** мати жодної інформації про анімації, затримки або інші аспекти візуалізації.
    - Ігрова логіка повинна оновлювати стан, а візуальні компоненти реагують на ці зміни, але не навпаки.
- [ ] **Аналіз коментарів:** Перед будь-яким рефакторингом ретельно вивчити існуючі коментарі в коді, що попереджають про потенційні проблеми та "крихкі" місця.

### Пріоритетні завдання для покращення

| Пріоритет (0-100) | Завдання | Опис |
| :--- | :--- | :--- |
| **100** | - [ ] **Посилення ізоляції UI та ігрової логіки.** | **Проблема:** Прямі виклики або залежності від анімацій можуть порушити ігрову логіку. **Рішення:** Переконатися, що ігрова логіка є чистою функцією стану та дії. Візуальні ефекти мають бути повністю відокремлені і реагувати лише на зміни стану, не впливаючи на нього. |
| **85** | - [ ] **Чітке розмежування відповідальності сервісів.** | **Проблема:** Ролі `gameService`, `gameLogicService` та `gameOrchestrator` перетинаються, що ускладнює розуміння та підтримку коду. **Рішення:** Провести рефакторинг: 1. `gameLogicService` - тільки чиста логіка гри (перевірка ходів, визначення переможця). 2. `gameService` - керування життєвим циклом гри (старт, пауза, завершення). 3. `gameOrchestrator` - диригент, що слухає події (`gameEventBus`) і викликає відповідні сервіси, мінімізуючи прямі залежності між ними. |
| **80** | - [ ] **Консолідація та аудит джерел правди (SSoT).** | **Проблема:** Деякі дані можуть бути дубльовані або їх джерело правди не є очевидним (наприклад, хто поточний гравець). **Рішення:** Провести аудит всіх сховищ. Створити карту стану, щоб чітко визначити, де "живе" кожен елемент даних. Використовувати `derived` стори для обчислюваних значень, щоб уникнути дублювання. |
| **70** | - [ ] **Формалізація потоку даних через Event Bus.** | **Проблема:** Реактивність через `subscribe` в сервісах може створювати складні для відладки ланцюгові реакції. **Рішення:** Розширити використання `gameEventBus`. Замість прямої підписки на зміни сторів, сервіси повинні реагувати на конкретні події. Це зробить потік даних більш явним та керованим. |
| **50** | - [ ] **Аудит локального стану в компонентах.** | **Проблема:** Компоненти можуть зберігати у своєму локальному стані дані, які є частиною глобального стану. **Рішення:** Переглянути ключові компоненти UI. Якщо локальний стан використовується для даних, що впливають на логіку або потрібні іншим компонентам, винести його до відповідного глобального сховища. |
