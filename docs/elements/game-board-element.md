# Елемент: Візуальна ігрова дошка (`BoardWrapperWidget.svelte`)

## Призначення (Purpose)

Цей компонент відповідає **виключно за візуалізацію** поточного стану гри. Він є "тупим" рендерером, який отримує дані зі сторів і відображає їх, включаючи анімації. Він не містить ігрової логіки і не змінює стан гри напряму.

## Джерело Правда (SSoT) та Залежності від Стану (State Dependencies)

1.  **`gameState`**:
    *   `boardSize`: для визначення розміру сітки.
    *   `availableMoves`: для відображення підказок (точок).
    *   `gameId`: для повного перерендерингу компонента при старті нової гри (через `{#key $gameState.gameId}`).
2.  **`settingsStore`**:
    *   `showBoard`, `showQueen`, `showMoves`: для умовного рендерингу елементів.
    *   `blockModeEnabled`, `blockOnVisitCount`: для стилізації заблокованих та "пошкоджених" клітинок.
3.  **`derivedState` (візуальна частина)**:
    *   **`visualPosition`**: **Ключова залежність.** Позиція ферзя береться саме звідси, а не напряму з `gameState`. Це дозволяє анімації відбуватися незалежно від логіки. `visualPosition` оновлюється `animationStore` після завершення анімації.
    *   **`visualCellVisitCounts`**: для відображення "пошкодження" клітинок.
    *   **`visualCurrentPlayerIndex`**: **Ключова залежність.** Індекс поточного гравця обчислюється на основі візуальної черги анімації, що дозволяє UI реагувати на те, що бачить користувач, а не на миттєвий логічний стан.
4.  **`animationStore`**:
    *   `isAnimating`: прапорець, що дозволяє приховувати точки під час анімації руху ферзя, щоб уникнути їх "перестрибування".

## Поведінка (Behavior)

1.  **Рендеринг сітки**: Створює сітку `N x N` на основі `$gameState.boardSize`.
2.  **Стилізація клітинок**:
    *   Застосовує класи `.light` та `.dark` для створення шахового візерунка.
    *   Застосовує класи `.cell-damage-*` та `.blocked-cell` на основі `$visualCellVisitCounts` та налаштувань `$settingsStore`.
3.  **Відображення ферзя**:
    *   Рендерить компонент `PlayerPiece.svelte`, якщо `$settingsStore.showQueen` має значення `true`.
    *   Позиція ферзя (`top`, `left`) обчислюється на основі `$visualPosition.row` та `$visualPosition.col`.
4.  **Відображення доступних ходів**:
    *   Рендерить точки на клітинках, якщо `$settingsStore.showMoves` має значення `true`, немає активної анімації (`!$animationStore.isAnimating`), і настала черга гравця (`$visualCurrentPlayerIndex === 0`).
5.  **Анімації**:
    *   Компонент **не ініціює** анімації. Він лише реагує на зміни в `visualPosition`. Плавність руху ферзя забезпечується CSS-переходом (`transition`) для властивостей `top` та `left` у `PlayerPiece.svelte`.
    *   **Поява та зникнення точок доступних ходів має бути плавною** (наприклад, через зміну `opacity`), щоб уникнути різкого "блимання".
    *   Поява/зникнення заблокованих клітинок також може бути анімована через CSS.

## Взаємодія з Користувачем (User Interaction)

-   **Лівий клік на дошку**: Викликає модальне вікно з підказкою, що керування відбувається через панель кнопок, а не кліками по дошці.
-   **Правий клік на клітинку (у режимі розробки)**: Може використовуватися для дебаг-дій, наприклад, для ручного блокування/розблокування клітинок.

## Архітектурні Нотатки та UI/UX

-   **Принцип SoC**: Цей компонент — ідеальний приклад розділення відповідальностей. Він нічого не знає про те, *чому* стан змінився (хід гравця, хід комп'ютера, скидання гри). Він лише відображає фінальний візуальний стан, який йому надають стори.
-   **Асинхронність**: Вся асинхронна логіка анімацій (паузи, послідовність) інкапсульована в `animationStore`. `BoardWrapperWidget` залишається синхронним і декларативним.
-   **Ключ `gameId`**: Використання `{#key $gameState.gameId}` є критично важливим. Це змушує Svelte повністю знищити та відтворити компонент дошки при старті нової гри, що гарантує очищення всіх внутрішніх станів та анімацій і запобігає "фантомним" ходам.

## Критерії Прийняття (Acceptance Criteria)

-   [ ] При старті нової гри дошка порожня, потім з'являється фігура, і лише після цього — плавно з'являються доступні ходи.
-   [ ] Фігура плавно переміщується з клітинки А в клітинку Б.
-   [ ] Під час руху ферзя доступні ходи (точки) приховані.
-   [ ] **Після завершення анімації ходу комп'ютера** плавно з'являються нові актуальні доступні ходи для гравця.
-   [ ] **Доступні ходи для комп'ютера ніколи не відображаються.**
-   [ ] Заблоковані та "пошкоджені" клітинки відображаються коректно згідно з `visualCellVisitCounts`.
-   [ ] При зміні розміру дошки сітка перебудовується правильно.
-   [ ] Клік по дошці викликає інформаційне модальне вікно.