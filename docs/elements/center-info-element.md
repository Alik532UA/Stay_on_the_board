# Документація Елемента Center Info

**Пов'язані документи:**
- [UI Компоненти](../logic/UI_COMPONENTS.md)
- [Логіка гри та потік даних](../logic/GAME_LOGIC_AND_DATA_FLOW.md)

## Огляд

Елемент `center-info` - це центральна кнопка в сітці напрямків гри "Залишитися на дошці", яка служить основним візуальним індикатором поточного стану вибору ходу гравця та відображення ходів VirtualPlayer.

## Розташування та Структура

### HTML Структура
```html
<button id="center-info" class="control-btn center-info" type="button"></button>
```

### Розташування
- **Позиція**: Центр сітки напрямків (позиція 5 в сітці 3x3)
- **Контекст**: Розташований між кнопками напрямків у візуальній сітці керування

### CSS Класи
- `.control-btn`: Базовий клас для кнопок керування
- `.center-info`: Специфічний клас для центральної кнопки інформації

## Функціональність

### Основні Функції
1. **Відображення Поточного Вибору**: Показує вибраний напрямок та/або відстань
2. **Показ Ходу VirtualPlayer**: Відображає останній хід VirtualPlayer після його виконання
3. **Підтвердження Ходу**: Стає клікабельною кнопкою для підтвердження ходу
4. **Візуальний Фідбек**: Надає інтуїтивний фідбек про стан гри

## Стани Елемента

### 1. Початковий Стан (Пауза між ходами)
- **Відображення**: Порожній контент
- **CSS Клас**: Без спеціальних класів
- **Курсор**: `default`
- **Клікабельний**: Ні
- **Стилі**: Без обводки, прозорий фон
- **Умова**: Не вибрано напрямок і відстань, немає ходу VirtualPlayer для показу
- **Призначення**: Пауза між ходом VirtualPlayer та початком вибору гравцем

### 2. Стан Показу Ходу VirtualPlayer
- **Відображення**: Останній хід VirtualPlayer (наприклад, `"→2"`)
- **CSS Клас**: `virtual-player-move-display`
- **Курсор**: `default`
- **Клікабельний**: Ні
- **Стилі**: Помаранчевий фон, без обводки
- **Умова**: Не вибрано напрямок і відстань, але існує `virtualPlayerLastMoveDisplay`

### 3. Стан Тільки Напрямок
- **Відображення**: Тільки стрілка напрямку (наприклад, `"→"`, `"↑"`, `"↙"`)
- **CSS Клас**: `direction-distance-state`
- **Курсор**: `default`
- **Клікабельний**: Ні
- **Стилі**: Без обводки, стандартний фон
- **Умова**: Вибрано напрямок, не вибрано відстань

### 4. Стан Тільки Відстань
- **Відображення**: Тільки число відстані (наприклад, `"2"`, `"3"`)
- **CSS Клас**: `direction-distance-state`
- **Курсор**: `default`
- **Клікабельний**: Ні
- **Стилі**: Без обводки, стандартний фон
- **Умова**: Вибрано відстань, не вибрано напрямок

### 5. Стан Повного Ходу (Підтверджуваний)
- **Відображення**: Напрямок + Відстань (наприклад, `"→2"`, `"↑3"`, `"↙1"`)
- **CSS Клас**: `confirm-btn-active`
- **Курсор**: `pointer`
- **Клікабельний**: Так (викликає `confirmMove()`)
- **Стилі**: Зелений фон, зелена обводка, анімація пульсації
- **Умова**: Вибрано і напрямок, і відстань

## Мапінг Стрілок Напрямку

| Напрямок | Символ | Опис |
|----------|--------|------|
| 1 | `↙` | Вниз-ліворуч |
| 2 | `↓` | Вниз |
| 3 | `↘` | Вниз-праворуч |
| 4 | `←` | Ліворуч |
| 6 | `→` | Праворуч |
| 7 | `↖` | Вгору-ліворуч |
| 8 | `↑` | Вгору |
| 9 | `↗` | Вгору-праворуч |

## CSS Стилі

### Базові Стилі
```css
#center-info {
    border: none !important; /* Завжди без обводки за замовчуванням */
}

/* Прозорий фон тільки для початкового стану (коли немає класів) */
#center-info:not(.confirm-btn-active):not(.virtual-player-move-display):not(.direction-distance-state) {
    background: transparent !important;
}
```

### Стилі за Станами
```css
/* Підтверджуваний стан */
#center-info.confirm-btn-active {
    background: var(--confirm-btn-bg);
    color: white;
    border-color: var(--confirm-btn-bg);
    animation: pulse 2s infinite;
    cursor: pointer;
}

#center-info.confirm-btn-active:hover {
    background: var(--confirm-btn-hover);
    border-color: var(--confirm-btn-hover);
    transform: scale(1.02);
}

/* Показ ходу VirtualPlayer */
#center-info.virtual-player-move-display {
    background-color: orange;
    border: none;
}
```

### Анімації
```css
@keyframes pulse {
    0% {
        box-shadow: 0 0 0 0 rgba(76, 175, 80, 0.7);
    }
    70% {
        box-shadow: 0 0 0 10px rgba(76, 175, 80, 0);
    }
    100% {
        box-shadow: 0 0 0 0 rgba(76, 175, 80, 0);
    }
}
```

## Технічна Реалізація

### Метод `updateCenterInfo()`
```javascript
updateCenterInfo() {
    const centerInfo = this.element.querySelector('#center-info');
    if (!centerInfo) return;
    
    // Видаляємо попередні обробники подій
    centerInfo.removeEventListener('click', this.centerInfoClickHandler);
    
    // Скидаємо всі стилі
    centerInfo.classList.remove('confirm-btn-active', 'virtual-player-move-display', 'direction-distance-state');
    centerInfo.style.cursor = 'default';
    centerInfo.style.border = 'none';
    centerInfo.style.backgroundColor = '';
    
    // Логіка визначення стану та відображення...
    
    // Якщо користувач нічого не вибрав, але є хід VirtualPlayer
    if (this.selectedDirection === null && this.selectedDistance === null && this.virtualPlayerLastMoveDisplay) {
        centerInfo.textContent = this.virtualPlayerLastMoveDisplay;
        centerInfo.classList.add('virtual-player-move-display');
        centerInfo.style.backgroundColor = 'orange';
        centerInfo.style.border = 'none';
        return;
    }
    
    // Логіка для інших станів...
}
```

### Змінні Стану
- `this.selectedDirection`: Поточний вибраний напрямок (1-9 або null)
- `this.selectedDistance`: Поточна вибрана відстань (1 до boardSize-1 або null)
- `this.virtualPlayerLastMoveDisplay`: Останній хід VirtualPlayer для відображення
- `this.distanceManuallySelected`: Флаг ручного вибору відстані
- `this.centerInfoClickHandler`: Обробник кліку для підтвердження ходу

### Обробники Подій
- **Клік**: При стані `.confirm-btn-active` викликає `confirmMove()`
- **Автоматичне оновлення**: Реагує на зміни в State Manager

## Інтеграція з Іншими Компонентами

### GameLogic
```javascript
// Показ ходу VirtualPlayer
gameControlsComponent.showVirtualPlayerMove(direction, distance);

// Очищення показу VirtualPlayer
gameControlsComponent.clearVirtualPlayerMove();
```

### State Manager
- Підписка на `game.selectedDirection`
- Підписка на `game.selectedDistance`
- Автоматичне оновлення при зміні стану

### Event Bus
- Випуск події `game:confirmMove` при кліку на підтверджуваний стан

## Приклади Використання

### Початковий Стан
```html
<button id="center-info" class="control-btn center-info" type="button"></button>
```
- **Контент**: Порожній
- **Стилі**: Без обводки, прозорий фон

### Хід VirtualPlayer
```html
<button id="center-info" class="control-btn center-info virtual-player-move-display" 
        style="background-color: orange; border: none;">→2</button>
```
- **Контент**: `"→2"` (напрямок + відстань)
- **Стилі**: Помаранчевий фон, без обводки

### Підтверджуваний Хід
```html
<button id="center-info" class="control-btn center-info confirm-btn-active" 
        style="cursor: pointer;">→2</button>
```
- **Контент**: `"→2"` (напрямок + відстань)
- **Стилі**: Зелений фон, зелена обводка, анімація, курсор pointer

## Обмеження та Особливості

### Обмеження
- Максимальна відстань обмежена розміром дошки (boardSize - 1)
- Показ VirtualPlayer очищається при виборі гравцем
- Тільки один стан може бути активним одночасно
- Клікабельність доступна тільки в підтверджуваному стані

### Особливості
- Автоматичне оновлення при зміні стану гри
- Збереження ручно вибраної відстані при зміні напрямку
- Інтуїтивний візуальний фідбек для користувача
- Помаранчевий фон для відрізнення ходів VirtualPlayer
- Анімація пульсації для привернення уваги до підтверджуваного ходу

### Логіка Фонів
- **Прозорий фон**: Тільки в початковому стані (пауза між ходами)
- **Помаранчевий фон**: При показі ходу VirtualPlayer
- **Зелений фон**: При підтверджуваному стані (готовий хід гравця)
- **Стандартний фон**: При виборі тільки напрямку або тільки відстані

## Клавіатурні Скорочення

### Взаємодія з Center Info
- **NumPad 5**: Підтвердження ходу (альтернатива кліку)
- **Клік на center-info**: Підтвердження ходу (коли доступно)

### Візуальні Індикатори
- **Порожній елемент**: Немає вибору
- **Стрілка**: Вибрано тільки напрямок
- **Число**: Вибрано тільки відстань
- **Стрілка + число**: Повний хід готовий до підтвердження
- **Помаранчевий фон**: Показ ходу VirtualPlayer

## Тестування

### Сценарії Тестування
1. **Початковий стан**: Перевірка порожнього відображення
2. **Вибір напрямку**: Перевірка відображення стрілки
3. **Вибір відстані**: Перевірка відображення числа
4. **Повний хід**: Перевірка клікабельності та анімації
5. **Хід VirtualPlayer**: Перевірка помаранчевого фону
6. **Очищення**: Перевірка скидання стану

### Очікувана Поведінка
- Плавні переходи між станами
- Правильне відображення символів напрямку
- Коректна робота клікабельності
- Відповідність візуальних стилів стану 

## Важлива логіка (2025)
- Хід VirtualPlayer у center-info зберігається до першої дії гравця (вибору напрямку або відстані), а не до підтвердження ходу. Це гарантує, що гравець завжди бачить останній хід VirtualPlayer, навіть якщо робить хід дуже швидко. 

## Архітектура (2025)
- Всі ходи (гравця і VirtualPlayer) одразу додаються у moveQueue (чергу ходів).
- Дошка лише анімує цю чергу у своєму темпі, не впливаючи на логіку center-info чи стан гри.
- Center-info завжди показує останній хід з moveQueue, навіть якщо дошка ще анімує попередні ходи.
- Таймери/анімації не блокують логіку гри.

# Список критеріїв прийняття для "center-info"

## 📋 **Загальні вимоги**

### ✅ **Структура та розташування**
- [ ] Елемент має HTML ID `#center-info`
- [ ] Елемент має CSS класи `.control-btn.center-info`
- [ ] Елемент є кнопкою типу `<button>`
- [ ] Елемент розташований в центрі сітки напрямків (позиція 5 в сітці 3x3)
- [ ] Елемент завжди має `border: none !important` за замовчуванням

## 🎯 **Функціональні критерії**

### ✅ **Відображення станів**
- [ ] **Початковий стан**: Порожній контент, прозорий фон, курсор `default`, не клікабельний
- [x] **Хід VirtualPlayer**: Показує хід у форматі "→2", помаранчевий фон, не клікабельний
- [ ] **Хід користувача, тільки напрямок**: Показує стрілку (наприклад, "→"), стандартний фон, не клікабельний
- [ ] **Хід користувача, Тільки відстань**: Показує число (наприклад, "2"), стандартний фон, не клікабельний
- [ ] **Хід користувача, повний хід**: Показує "→2", зелений фон, зелена обводка, анімація пульсації, курсор `pointer`, клікабельний

### ✅ **Мапінг напрямків**
- [ ] Напрямок 1 відображається як `↙` (вниз-ліворуч)
- [ ] Напрямок 2 відображається як `↓` (вниз)
- [ ] Напрямок 3 відображається як `↘` (вниз-праворуч)
- [ ] Напрямок 4 відображається як `←` (ліворуч)
- [ ] Напрямок 6 відображається як `→` (праворуч)
- [ ] Напрямок 7 відображається як `↖` (вгору-ліворуч)
- [ ] Напрямок 8 відображається як `↑` (вгору)
- [ ] Напрямок 9 відображається як `↗` (вгору-праворуч)

### ✅ **Логіка відображення ходу VirtualPlayer**
- [x] Хід VirtualPlayer зберігається до першої дії гравця (вибору напрямку або відстані)
- [x] Хід VirtualPlayer НЕ очищається при підтвердженні ходу гравця
- [x] Хід VirtualPlayer очищається тільки при виборі напрямку або відстані гравцем
- [x] Хід VirtualPlayer відображається з помаранчевим фоном

### ✅ **Взаємодія**
- [ ] Клік на елемент підтверджує хід тільки в стані "повний хід"
- [ ] NumPad 5 також підтверджує хід (альтернатива кліку)
- [ ] Hover ефект збільшує масштаб на 1.02 при підтверджуваному стані

## 🎨 **Візуальні критерії**

### ✅ **CSS стилі за станами**
- [ ] **Початковий стан**: `background: transparent`, `border: none`
- [x] **Хід VirtualPlayer**: `background-color: orange`, `border: none`
- [ ] **Повний хід**: `background: var(--confirm-btn-bg)`, `color: white`, `border-color: var(--confirm-btn-bg)`
- [ ] **Hover для повного ходу**: `background: var(--confirm-btn-hover)`, `border-color: var(--confirm-btn-hover)`

### ✅ **Анімації**
- [ ] Анімація пульсації застосовується до стану `.confirm-btn-active`
- [ ] Анімація має тривалість 2 секунди з нескінченним повторенням
- [ ] Анімація створює ефект тіні з зеленим кольором

## ⚙️ **Технічні критерії**

### ✅ **Архітектурні принципи**
- [x] Center-info НЕ залежить від анімації дошки
- [x] Center-info завжди показує останній хід з moveQueue
- [x] Анімація дошки не впливає на логіку center-info
- [x] Center-info оновлюється незалежно від стану анімації

### ✅ **Інтеграція**
- [ ] Підписка на `game.selectedDirection` в State Manager
- [ ] Підписка на `game.selectedDistance` в State Manager
- [ ] Автоматичне оновлення при зміні стану гри
- [ ] Випуск події `game:confirmMove` при кліку

### ✅ **Обробка подій**
- [ ] Видалення попередніх обробників подій перед додаванням нових
- [ ] Скидання всіх CSS класів при оновленні
- [ ] Правильне встановлення курсора залежно від стану

## 🧪 **Тестування**

### ✅ **Сценарії тестування**
- [ ] Початковий стан показує порожній контент
- [ ] Вибір напрямку відображає правильну стрілку
- [ ] Вибір відстані відображає правильне число
- [ ] Повний хід стає клікабельним з анімацією та зеленим фоном
- [x] Хід комп'ютера відображається з помаранчевим фоном
- [ ] Очищення стану скидає всі стилі

### ✅ **Граничні випадки**
- [x] Швидкі ходи після ходу комп'ютера не порушують відображення
- [ ] Максимальна відстань обмежена розміром дошки (boardSize - 1)
- [ ] Збереження ручно вибраної відстані при зміні напрямку
- [ ] Тільки один стан активний одночасно

## 🚫 **Обмеження**

### ✅ **Заборонена поведінка**
- [x] Center-info НЕ повинен залежати від анімації дошки
- [ ] Center-info НЕ повинен показувати старі ходи після програшного ходу
- [ ] Center-info НЕ повинен мати обводку в будь-якому стані
- [ ] Center-info НЕ повинен бути клікабельним в неправильних станах

## ✅ **Реалізовані зміни (2025)**

### ✅ **Оновлення документації**
- [x] Оновлено опис стану "Повний хід" в `CENTER_INFO_ELEMENT.md`
- [x] Оновлено опис стану "Повний хід" в `UI_COMPONENTS.md`
- [x] Оновлено приклади використання з зеленим фоном

### ✅ **Оновлення CSS стилів**
- [x] Додано анімацію пульсації до `#center-info.confirm-btn-active`
- [x] Зелений фон вже присутній в CSS змінних `var(--confirm-btn-bg)`
- [x] Зелена обводка вже присутня в CSS стилях

### ✅ **Технічна реалізація**
- [x] Логіка реалізована в `centerInfoUtil.ts` через функцію `getCenterInfoState`
- [x] CSS клас `confirm-btn-active` правильно застосовується
- [x] Анімація пульсації вже присутня в CSS

Цей список критеріїв прийняття забезпечує повну відповідність компонента "center-info" вимогам документації та архітектурним принципам проекту.

## ✅ Виправлення відображення ходу VirtualPlayer (2025-01-27)
- **Проблема**: Стан "Хід VirtualPlayer" не відображався через відсутність `lastVirtualPlayerMove` в `ControlsPanelWidget.svelte`
- **Рішення**: 
  1. Додано імпорт `lastVirtualPlayerMove` з `derivedState.ts` в `ControlsPanelWidget.svelte`
  2. Передано `$lastVirtualPlayerMove` замість `null` в `getCenterInfoState()`
  3. Додано локальні стилі для `#center-info.virtual-player-move-display` з помаранчевим фоном
- **Результат**: Хід VirtualPlayer тепер правильно відображається з помаранчевим фоном та текстом "→2"
- **Файли**: 
  - `src/lib/components/widgets/ControlsPanelWidget.svelte` рядки 12, 20, 26
  - `src/lib/components/widgets/DirectionControls.svelte` рядки 145-151

## ✅ Виправлення анімації ходів з паузами (2025-01-27)
- **Проблема**: Фігура одразу переміщувалася на позицію після ходу VirtualPlayer, пропускаючи анімацію ходу гравця
- **Рішення**: 
  1. Оновлено функцію `animateMovesWithPause` в `animationStore.ts`
  2. Реалізовано покрокову анімацію: спочатку хід гравця, потім пауза 1 секунда, потім хід VirtualPlayer
  3. Пауза не впливає на `center-info`, який оновлюється миттєво
- **Результат**: 
  - Фігура займає нове положення після ходу користувача
  - Секунда паузи
  - Фігура займає нове положення після ходу VirtualPlayer
  - `center-info` показує хід VirtualPlayer одразу, незалежно від анімації
- **Файли**: 
  - `src/lib/stores/animationStore.ts` рядки 250-290 